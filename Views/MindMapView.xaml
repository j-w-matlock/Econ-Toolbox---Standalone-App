<UserControl x:Class="EconToolbox.Desktop.Views.MindMapView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:EconToolbox.Desktop.ViewModels"
             xmlns:local="clr-namespace:EconToolbox.Desktop.Views"
             Background="{StaticResource Brush.SurfaceAlt}"
             SnapsToDevicePixels="True"
             UseLayoutRounding="True">
    <UserControl.Resources>
        <Style x:Key="ConnectionLineStyle" TargetType="Polyline">
            <Setter Property="Stroke" Value="{Binding DataContext.SelectedConnectionStyle.StrokeBrush, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
            <Setter Property="StrokeThickness" Value="{Binding DataContext.SelectedConnectionStyle.Thickness, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
            <Setter Property="StrokeStartLineCap" Value="{Binding DataContext.SelectedConnectionStyle.LineCap, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
            <Setter Property="StrokeEndLineCap" Value="{Binding DataContext.SelectedConnectionStyle.LineCap, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
            <Setter Property="StrokeLineJoin" Value="Round"/>
            <Setter Property="StrokeDashArray" Value="{Binding DataContext.SelectedConnectionStyle.DashArray, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
            <Setter Property="Opacity" Value="0.96"/>
            <Setter Property="Fill" Value="Transparent"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect BlurRadius="6"
                                      ShadowDepth="0"
                                      Color="#132952"
                                      Opacity="0.28"/>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0"
                Style="{StaticResource Border.Explainer}"
                Margin="0,0,0,16"
                Padding="{StaticResource Padding.Card}">
            <StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <Viewbox Width="32" Height="32" Margin="0,0,10,0">
                        <Canvas Width="32" Height="32">
                            <Path Stroke="{StaticResource Brush.Primary}"
                                  StrokeThickness="2.4"
                                  StrokeLineJoin="Round"
                                  StrokeStartLineCap="Round"
                                  StrokeEndLineCap="Round">
                                <Path.Data>
                                    <GeometryGroup>
                                        <PathGeometry>
                                            <PathFigure StartPoint="12,8" IsClosed="False">
                                                <BezierSegment Point1="6,10" Point2="6,16" Point3="12,18"/>
                                                <BezierSegment Point1="6,20" Point2="6,26" Point3="12,28"/>
                                            </PathFigure>
                                        </PathGeometry>
                                        <PathGeometry>
                                            <PathFigure StartPoint="20,8" IsClosed="False">
                                                <BezierSegment Point1="26,10" Point2="26,16" Point3="20,18"/>
                                                <BezierSegment Point1="26,20" Point2="26,26" Point3="20,28"/>
                                            </PathFigure>
                                        </PathGeometry>
                                        <PathGeometry>
                                            <PathFigure StartPoint="12,12" IsClosed="False">
                                                <BezierSegment Point1="16,10" Point2="18,10" Point3="20,12"/>
                                            </PathFigure>
                                        </PathGeometry>
                                        <PathGeometry>
                                            <PathFigure StartPoint="12,16" IsClosed="False">
                                                <BezierSegment Point1="16,14" Point2="18,14" Point3="20,16"/>
                                            </PathFigure>
                                        </PathGeometry>
                                        <PathGeometry>
                                            <PathFigure StartPoint="12,20" IsClosed="False">
                                                <BezierSegment Point1="16,18" Point2="18,18" Point3="20,20"/>
                                            </PathFigure>
                                        </PathGeometry>
                                    </GeometryGroup>
                                </Path.Data>
                            </Path>
                        </Canvas>
                    </Viewbox>
                    <TextBlock Text="Mind Map Planner"
                               FontSize="18"
                               FontWeight="Bold"
                               Foreground="{StaticResource Brush.Primary}"/>
                </StackPanel>
                <TextBlock Margin="0,6,0,0"
                           TextWrapping="Wrap">
                    Right-click anywhere on the canvas to create new root, child, or sibling ideas. Drag the icons to
                    arrange your tree and use the panel on the right to fill in the details.
                </TextBlock>
            </StackPanel>
        </Border>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*"/>
                <ColumnDefinition Width="2*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0"
                    Background="{StaticResource Brush.Surface}"
                    CornerRadius="12"
                    Padding="18"
                    Margin="0,0,12,0"
                    BorderBrush="{StaticResource Brush.Border}"
                    BorderThickness="1">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0">
                        <TextBlock Text="Interactive Mind Map"
                                   FontSize="16"
                                   FontWeight="SemiBold"/>
                        <TextBlock Margin="0,4,0,0"
                                   Foreground="{StaticResource Brush.TextSecondary}"
                                   Text="Right-click to add ideas, and drag icons to re-arrange your thinking."/>
                        <StackPanel Orientation="Horizontal"
                                    Margin="0,10,0,0"
                                    VerticalAlignment="Center">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                ToolTip="Adjust to zoom the canvas in or out."/>
                                <TextBlock Text="Zoom"
                                           Margin="4,0,0,0"
                                           VerticalAlignment="Center"
                                           Foreground="{StaticResource Brush.TextSecondary}"/>
                            </StackPanel>
                            <Slider Width="160"
                                    Margin="10,0,0,0"
                                    Minimum="{Binding ZoomLevelMinimum}"
                                    Maximum="{Binding ZoomLevelMaximum}"
                                    Value="{Binding ZoomLevel, Mode=TwoWay}"
                                    TickFrequency="0.1"
                                    IsSnapToTickEnabled="False"
                                    SmallChange="0.05"
                                    LargeChange="0.2"
                                    VerticalAlignment="Center"
                                    ToolTip="Drag to change the zoom level of the mind map."/>
                            <TextBlock Text="{Binding ZoomLevel, StringFormat={}{0:P0}}"
                                       Margin="10,0,0,0"
                                       FontWeight="SemiBold"
                                       VerticalAlignment="Center"
                                       Foreground="{StaticResource Brush.Primary}"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal"
                                    Margin="0,8,0,0"
                                    VerticalAlignment="Center">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                ToolTip="Choose the wiring look for parent-child connections."/>
                                <TextBlock Text="Edge style"
                                           Margin="4,0,0,0"
                                           VerticalAlignment="Center"
                                           Foreground="{StaticResource Brush.TextSecondary}"/>
                            </StackPanel>
                            <ComboBox ItemsSource="{Binding ConnectionStyles}"
                                      SelectedItem="{Binding SelectedConnectionStyle, Mode=TwoWay}"
                                      Width="180"
                                      Margin="10,0,0,0"
                                      VerticalAlignment="Center"
                                      ToolTip="Swap between solid, dashed, or dotted wiring styles.">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate DataType="{x:Type vm:MindMapConnectionStyleOption}">
                                        <StackPanel Orientation="Vertical" Margin="2,4">
                                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                            <TextBlock Text="{Binding Description}" FontSize="11" Foreground="{StaticResource Brush.TextSecondary}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </StackPanel>
                    </StackPanel>

                    <ScrollViewer Grid.Row="1"
                                  Margin="0,12,0,0"
                                  HorizontalScrollBarVisibility="Auto"
                                  VerticalScrollBarVisibility="Auto">
                        <Grid>
                            <Grid.LayoutTransform>
                                <ScaleTransform ScaleX="{Binding ZoomLevel}" ScaleY="{Binding ZoomLevel}"/>
                            </Grid.LayoutTransform>
                            <ItemsControl ItemsSource="{Binding Connections}"
                                          IsHitTestVisible="False"
                                          Panel.ZIndex="0">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas Width="{Binding CanvasWidth}"
                                                Height="{Binding CanvasHeight}"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="{x:Type vm:MindMapConnectionViewModel}">
                                        <Canvas IsHitTestVisible="False">
                                            <Polyline Style="{StaticResource ConnectionLineStyle}"
                                                      Points="{Binding ConnectorPoints}"/>
                                            <Rectangle Width="8"
                                                       Height="8"
                                                       RadiusX="1"
                                                       RadiusY="1"
                                                       Fill="{Binding DataContext.SelectedConnectionStyle.AnchorFillBrush, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                       Stroke="{Binding DataContext.SelectedConnectionStyle.StrokeBrush, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                       StrokeThickness="1.2"
                                                       Canvas.Left="{Binding FirstBend.X, Converter={StaticResource OffsetConverter}, ConverterParameter=4}"
                                                       Canvas.Top="{Binding FirstBend.Y, Converter={StaticResource OffsetConverter}, ConverterParameter=4}"/>
                                            <Rectangle Width="8"
                                                       Height="8"
                                                       RadiusX="1"
                                                       RadiusY="1"
                                                       Fill="{Binding DataContext.SelectedConnectionStyle.AnchorFillBrush, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                       Stroke="{Binding DataContext.SelectedConnectionStyle.StrokeBrush, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                       StrokeThickness="1.2"
                                                       Canvas.Left="{Binding SecondBend.X, Converter={StaticResource OffsetConverter}, ConverterParameter=4}"
                                                       Canvas.Top="{Binding SecondBend.Y, Converter={StaticResource OffsetConverter}, ConverterParameter=4}"/>
                                            <Ellipse Width="10"
                                                     Height="10"
                                                     Fill="White"
                                                     Stroke="{Binding DataContext.SelectedConnectionStyle.StrokeBrush, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                     StrokeThickness="1.4"
                                                     Canvas.Left="{Binding StartX, Converter={StaticResource OffsetConverter}, ConverterParameter=5}"
                                                     Canvas.Top="{Binding StartY, Converter={StaticResource OffsetConverter}, ConverterParameter=5}"/>
                                            <Ellipse Width="10"
                                                     Height="10"
                                                     Fill="{Binding DataContext.SelectedConnectionStyle.StrokeBrush, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                     Stroke="{Binding DataContext.SelectedConnectionStyle.GlowBrush, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                     StrokeThickness="1"
                                                     Canvas.Left="{Binding EndX, Converter={StaticResource OffsetConverter}, ConverterParameter=5}"
                                                     Canvas.Top="{Binding EndY, Converter={StaticResource OffsetConverter}, ConverterParameter=5}"/>
                                        </Canvas>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <ItemsControl x:Name="NodeItemsControl"
                                          ItemsSource="{Binding CanvasNodes}"
                                          Loaded="OnNodesLoaded"
                                          PreviewMouseRightButtonDown="OnCanvasRightButtonDown"
                                          Panel.ZIndex="1">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas Width="{Binding CanvasWidth}"
                                                Height="{Binding CanvasHeight}"
                                                Background="#F8FBFF"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemContainerStyle>
                                    <Style TargetType="ContentPresenter">
                                        <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                        <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                                    </Style>
                                </ItemsControl.ItemContainerStyle>
                                <ItemsControl.ContextMenu>
                                    <ContextMenu Opened="OnCanvasContextMenuOpened">
                                        <MenuItem Header="Add Root Idea"
                                                  Click="OnCanvasAddRoot"/>
                                        <MenuItem Header="Add Child Idea"
                                                  Click="OnCanvasAddChild"/>
                                        <MenuItem Header="Add Sibling Idea"
                                                  Click="OnCanvasAddSibling"/>
                                    </ContextMenu>
                                </ItemsControl.ContextMenu>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="{x:Type vm:MindMapNodeViewModel}">
                                        <Border Padding="12"
                                                Background="White"
                                                CornerRadius="18"
                                                BorderBrush="#CFDAED"
                                                BorderThickness="1.2"
                                                MouseLeftButtonDown="Node_MouseLeftButtonDown"
                                                MouseLeftButtonUp="Node_MouseLeftButtonUp"
                                                MouseMove="Node_MouseMove"
                                                MouseRightButtonDown="Node_MouseRightButtonDown"
                                                SizeChanged="Node_SizeChanged">
                                            <Border.Effect>
                                                <DropShadowEffect BlurRadius="14"
                                                                  ShadowDepth="3"
                                                                  Color="#1F3D66"
                                                                  Opacity="0.18"/>
                                            </Border.Effect>
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Opacity" Value="0.95"/>
                                                    <Setter Property="Cursor" Value="Hand"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                            <Setter Property="Opacity" Value="1"/>
                                                            <Setter Property="BorderBrush" Value="#2B6CB0"/>
                                                            <Setter Property="BorderThickness" Value="2.2"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <Border.ContextMenu>
                                                <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}"
                                                             Opened="OnNodeContextMenuOpened">
                                                    <MenuItem Header="Add Child"
                                                              Click="OnNodeAddChild"/>
                                                    <MenuItem Header="Add Sibling"
                                                              Click="OnNodeAddSibling"/>
                                                    <Separator/>
                                                    <MenuItem Header="Remove"
                                                              Click="OnNodeRemove"/>
                                                </ContextMenu>
                                            </Border.ContextMenu>
                                            <Border.ToolTip>
                                                <StackPanel MaxWidth="240">
                                                    <TextBlock Text="{Binding Title}" FontWeight="Bold"/>
                                                    <TextBlock Text="{Binding ParentTitle}"
                                                               Margin="0,2,0,0"
                                                               Foreground="{StaticResource Brush.TextSecondary}"/>
                                                    <Separator Margin="0,6,0,6"/>
                                                    <TextBlock Text="Relationship Notes" FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding RelationshipNotes}"
                                                               TextWrapping="Wrap"
                                                               Foreground="{StaticResource Brush.TextSecondary}"/>
                                                    <Separator Margin="0,6,0,6"/>
                                                    <TextBlock Text="Notes" FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding Notes}" TextWrapping="Wrap"/>
                                                </StackPanel>
                                            </Border.ToolTip>
                                            <Grid Width="210">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                <StackPanel Grid.Row="0" HorizontalAlignment="Center">
                                                    <Grid Width="72" Height="72">
                                                        <Ellipse Fill="#E5ECFF"
                                                                 Stroke="#94ACD6"
                                                                 StrokeThickness="1.6"/>
                                                        <Path Data="M 8,36 L 64,36"
                                                              Stroke="#CCD8F7"
                                                              StrokeThickness="3"
                                                              StrokeDashArray="1 7"
                                                              StrokeDashCap="Round"
                                                              SnapsToDevicePixels="True"/>
                                                        <TextBlock Text="{Binding IconGlyph}"
                                                                   FontSize="34"
                                                                   FontFamily="Segoe UI Emoji"
                                                                   VerticalAlignment="Center"
                                                                   HorizontalAlignment="Center"/>
                                                    </Grid>
                                                    <TextBlock Text="{Binding Title}"
                                                               Margin="0,8,0,0"
                                                               FontWeight="SemiBold"
                                                               FontSize="14"
                                                               TextAlignment="Center"
                                                               Foreground="{StaticResource Brush.Primary}"
                                                               TextWrapping="Wrap"/>
                                                </StackPanel>
                                                <TextBlock Grid.Row="1"
                                                           Text="{Binding Notes}"
                                                           Margin="0,6,0,0"
                                                           FontSize="12"
                                                           Foreground="{StaticResource Brush.TextSecondary}"
                                                           TextAlignment="Center"
                                                           TextTrimming="CharacterEllipsis"
                                                           TextWrapping="Wrap"
                                                           MaxHeight="50"/>
                                                <TextBlock Grid.Row="2"
                                                           Text="{Binding RelationshipNotes}"
                                                           Margin="0,6,0,0"
                                                           FontSize="11"
                                                           FontStyle="Italic"
                                                           Foreground="{StaticResource Brush.TextSecondary}"
                                                           TextAlignment="Center"
                                                           TextTrimming="CharacterEllipsis"
                                                           TextWrapping="Wrap"
                                                           MaxHeight="44"/>
                                                <StackPanel Grid.Row="3"
                                                            Margin="0,10,0,0"
                                                            HorizontalAlignment="Center">
                                                    <StackPanel Orientation="Horizontal"
                                                                HorizontalAlignment="Center">
                                                        <Border Margin="0,0,6,0"
                                                                Padding="6,4"
                                                                Background="#F3F6FF"
                                                                BorderBrush="#C0D2F7"
                                                                BorderThickness="1"
                                                                CornerRadius="10">
                                                            <StackPanel Orientation="Horizontal">
                                                                <TextBlock Text="P"
                                                                           FontWeight="Bold"
                                                                           Foreground="{StaticResource Brush.Primary}"/>
                                                                <TextBlock Text="{Binding ParentTitle}"
                                                                           Margin="4,0,0,0"
                                                                           Foreground="{StaticResource Brush.TextSecondary}"
                                                                           TextTrimming="CharacterEllipsis"
                                                                           MaxWidth="100"/>
                                                            </StackPanel>
                                                        </Border>
                                                        <Border Margin="0,0,6,0"
                                                                Padding="6,4"
                                                                Background="#F9F3FF"
                                                                BorderBrush="#D7C5FF"
                                                                BorderThickness="1"
                                                                CornerRadius="10">
                                                            <StackPanel Orientation="Horizontal">
                                                                <TextBlock Text="C"
                                                                           FontWeight="Bold"
                                                                           Foreground="#7F56D9"/>
                                                                <TextBlock Text="{Binding Children.Count, StringFormat=Children: {0}}"
                                                                           Margin="4,0,0,0"
                                                                           Foreground="{StaticResource Brush.TextSecondary}"/>
                                                            </StackPanel>
                                                        </Border>
                                                        <Border Padding="6,4"
                                                                Background="#F0FCFB"
                                                                BorderBrush="#A7E0DA"
                                                                BorderThickness="1"
                                                                CornerRadius="10">
                                                            <StackPanel Orientation="Horizontal">
                                                                <TextBlock Text="S"
                                                                           FontWeight="Bold"
                                                                           Foreground="#15998E"/>
                                                                <TextBlock Text="{Binding SiblingCount, StringFormat=Siblings: {0}}"
                                                                           Margin="4,0,0,0"
                                                                           Foreground="{StaticResource Brush.TextSecondary}"/>
                                                            </StackPanel>
                                                        </Border>
                                                    </StackPanel>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </ScrollViewer>
                </Grid>
            </Border>

            <Border Grid.Column="1"
                    Background="{StaticResource Brush.Surface}"
                    CornerRadius="12"
                    Padding="20"
                    BorderBrush="{StaticResource Brush.Border}"
                    BorderThickness="1">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0">
                        <TextBlock Text="Idea Details"
                                   FontSize="18"
                                   FontWeight="SemiBold"/>
                        <TextBlock Margin="0,4,0,12"
                                   TextWrapping="Wrap"
                                   Foreground="{StaticResource Brush.TextSecondary}"
                                   Text="Select a node to adjust its icon, notes, and relationship wiring."/>
                    </StackPanel>

                    <Border Grid.Row="1"
                            Background="{StaticResource Brush.HighlightBackground}"
                            BorderBrush="{StaticResource Brush.HighlightBorder}"
                            BorderThickness="1"
                            CornerRadius="8"
                            Padding="10"
                            Margin="0,0,0,12">
                        <TextBlock Text="{Binding SelectedPath}"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource Brush.Primary}"
                                   TextWrapping="Wrap">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding SelectedNode}" Value="{x:Null}">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Border>

                    <TextBlock Grid.Row="2"
                               Text="Right-click on the canvas to add your first idea."
                               VerticalAlignment="Center"
                               HorizontalAlignment="Center"
                               Foreground="{StaticResource Brush.TextSecondary}"
                               FontSize="14"
                               TextWrapping="Wrap"
                               TextAlignment="Center">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding SelectedNode}" Value="{x:Null}">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>

                    <ContentControl Grid.Row="2"
                                    Content="{Binding SelectedNode}">
                        <ContentControl.Style>
                            <Style TargetType="ContentControl">
                                <Setter Property="Visibility" Value="Visible"/>
                                <Style.Triggers>
                                    <Trigger Property="Content" Value="{x:Null}">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </ContentControl.Style>
                        <ContentControl.ContentTemplate>
                            <DataTemplate DataType="{x:Type vm:MindMapNodeViewModel}">
                                <StackPanel>
                                    <StackPanel Margin="0,0,0,16">
                                        <TextBlock FontWeight="SemiBold">
                                            <InlineUIContainer BaselineAlignment="Center">
                                                <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                                ToolTip="Name this idea or topic as it should appear on the map."/>
                                            </InlineUIContainer>
                                            <Run Text="Idea Title"/>
                                        </TextBlock>
                                        <TextBox Text="{Binding Title, UpdateSourceTrigger=PropertyChanged}"
                                                 Margin="0,6,0,0"
                                                 MinHeight="28"/>
                                    </StackPanel>

                                    <Border Background="{StaticResource Brush.SurfaceAlt}"
                                            BorderBrush="{StaticResource Brush.Border}"
                                            BorderThickness="1"
                                            CornerRadius="8"
                                            Padding="12"
                                            Margin="0,0,0,16">
                                        <StackPanel>
                                            <TextBlock Text="Icon &amp; emphasis" FontWeight="SemiBold"/>
                                            <ListBox ItemsSource="{Binding DataContext.IconPalette, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                     SelectedValuePath="Glyph"
                                                     SelectedValue="{Binding IconGlyph, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                     BorderThickness="0"
                                                     Background="Transparent"
                                                     Margin="0,8,0,0"
                                                     ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                                     HorizontalContentAlignment="Stretch">
                                                <ListBox.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel/>
                                                    </ItemsPanelTemplate>
                                                </ListBox.ItemsPanel>
                                                <ListBox.ItemContainerStyle>
                                                    <Style TargetType="ListBoxItem">
                                                        <Setter Property="Padding" Value="0"/>
                                                        <Setter Property="Margin" Value="0,4,8,4"/>
                                                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                                        <Setter Property="Background" Value="Transparent"/>
                                                        <Setter Property="BorderThickness" Value="0"/>
                                                    </Style>
                                                </ListBox.ItemContainerStyle>
                                                <ListBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Padding="8"
                                                                ToolTip="{Binding Description}">
                                                            <Border.Style>
                                                                <Style TargetType="Border">
                                                                    <Setter Property="Background" Value="#F4F6FB"/>
                                                                    <Setter Property="BorderBrush" Value="#C6D6F6"/>
                                                                    <Setter Property="BorderThickness" Value="1"/>
                                                                    <Setter Property="CornerRadius" Value="12"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}"
                                                                                     Value="True">
                                                                            <Setter Property="Background" Value="#E2E9FD"/>
                                                                            <Setter Property="BorderBrush" Value="#2B6CB0"/>
                                                                            <Setter Property="BorderThickness" Value="2"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </Border.Style>
                                                            <StackPanel HorizontalAlignment="Center">
                                                                <TextBlock Text="{Binding Glyph}"
                                                                           FontSize="20"
                                                                           HorizontalAlignment="Center"/>
                                                                <TextBlock Text="{Binding Label}"
                                                                           Margin="0,4,0,0"
                                                                           FontSize="11"
                                                                           Foreground="{StaticResource Brush.TextSecondary}"
                                                                           HorizontalAlignment="Center"/>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ListBox.ItemTemplate>
                                            </ListBox>
                                        </StackPanel>
                                    </Border>

                                    <StackPanel Margin="0,0,0,16">
                                        <TextBlock FontWeight="SemiBold">
                                            <InlineUIContainer BaselineAlignment="Center">
                                                <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                                ToolTip="Capture supporting notes, context, or actions for the selected idea."/>
                                            </InlineUIContainer>
                                            <Run Text="Key Points / Notes"/>
                                        </TextBlock>
                                        <TextBox Text="{Binding Notes, UpdateSourceTrigger=PropertyChanged}"
                                                 Margin="0,6,0,0"
                                                 AcceptsReturn="True"
                                                 TextWrapping="Wrap"
                                                 Height="160"
                                                 VerticalScrollBarVisibility="Auto"/>
                                    </StackPanel>

                                    <StackPanel Margin="0,0,0,16">
                                        <TextBlock FontWeight="SemiBold">
                                            <InlineUIContainer BaselineAlignment="Center">
                                                <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                                ToolTip="Describe how this node ties into surrounding ideas."/>
                                            </InlineUIContainer>
                                            <Run Text="Relationship Notes"/>
                                        </TextBlock>
                                        <TextBox Text="{Binding RelationshipNotes, UpdateSourceTrigger=PropertyChanged}"
                                                 Margin="0,6,0,0"
                                                 AcceptsReturn="True"
                                                 TextWrapping="Wrap"
                                                 Height="120"
                                                 VerticalScrollBarVisibility="Auto"/>
                                    </StackPanel>

                                    <Grid Margin="0,0,0,16">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition/>
                                            <ColumnDefinition/>
                                        </Grid.ColumnDefinitions>
                                        <Border Background="{StaticResource Brush.SurfaceAlt}"
                                                BorderBrush="{StaticResource Brush.Border}"
                                                BorderThickness="1"
                                                CornerRadius="6"
                                                Padding="12"
                                                Margin="0,0,8,0">
                                            <StackPanel>
                                                <TextBlock Text="Parent link" FontWeight="SemiBold"/>
                                                <TextBlock Text="{Binding ParentTitle}"
                                                           Margin="0,6,0,0"
                                                           TextWrapping="Wrap">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Foreground" Value="{StaticResource Brush.Primary}"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding HasParent}" Value="False">
                                                                    <Setter Property="Foreground" Value="{StaticResource Brush.TextSecondary}"/>
                                                                    <Setter Property="FontStyle" Value="Italic"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                                <TextBlock Text="Use Add Parent/Sibling menus to rewire this connection."
                                                           Margin="0,6,0,0"
                                                           FontSize="11"
                                                           Foreground="{StaticResource Brush.TextSecondary}"
                                                           TextWrapping="Wrap"/>
                                            </StackPanel>
                                        </Border>
                                        <Border Grid.Column="1"
                                                Background="{StaticResource Brush.SurfaceAlt}"
                                                BorderBrush="{StaticResource Brush.Border}"
                                                BorderThickness="1"
                                                CornerRadius="6"
                                                Padding="12">
                                            <StackPanel>
                                                <TextBlock Text="Sibling ideas" FontWeight="SemiBold"/>
                                                <ItemsControl x:Name="SiblingItems"
                                                              ItemsSource="{Binding Siblings}"
                                                              Margin="0,6,0,0">
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <StackPanel Orientation="Horizontal" Margin="0,2,0,2">
                                                                <TextBlock Text=""
                                                                           FontSize="14"
                                                                           Margin="0,0,6,0"
                                                                           Foreground="{StaticResource Brush.Primary}"/>
                                                                <TextBlock Text="{Binding Title}"/>
                                                            </StackPanel>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                                <TextBlock Text="No sibling ideas yet. Use Add Sibling to keep branches aligned."
                                                           Margin="0,4,0,0"
                                                           Foreground="{StaticResource Brush.TextSecondary}"
                                                           TextWrapping="Wrap">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding HasItems, ElementName=SiblingItems}" Value="False">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </StackPanel>
                                        </Border>
                                    </Grid>

                                    <Border Background="{StaticResource Brush.SurfaceAlt}"
                                            BorderBrush="{StaticResource Brush.Border}"
                                            BorderThickness="1"
                                            CornerRadius="6"
                                            Padding="12">
                                        <StackPanel>
                                            <TextBlock Text="Child ideas"
                                                       FontWeight="SemiBold"/>
                                            <ItemsControl ItemsSource="{Binding Children}"
                                                          Margin="0,6,0,0">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <StackPanel Orientation="Horizontal" Margin="0,2,0,2">
                                                            <TextBlock Text=""
                                                                       FontSize="16"
                                                                       Margin="0,0,6,0"
                                                                       Foreground="{StaticResource Brush.Primary}"/>
                                                            <TextBlock Text="{Binding Title}"/>
                                                        </StackPanel>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                                <ItemsControl.Style>
                                                    <Style TargetType="ItemsControl">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Children.Count}" Value="0">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ItemsControl.Style>
                                            </ItemsControl>
                                            <TextBlock Text="No child ideas yet. Use the context menu to break this topic down further."
                                                       Foreground="{StaticResource Brush.TextSecondary}"
                                                       TextWrapping="Wrap">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Children.Count}" Value="0">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </DataTemplate>
                        </ContentControl.ContentTemplate>
                    </ContentControl>
                </Grid>
            </Border>
        </Grid>
        <StackPanel Grid.Row="2" Margin="0,16,0,0">
            <Border Style="{StaticResource Border.ResultInfo}">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="" FontSize="18" Foreground="{StaticResource Brush.Primary}" Margin="0,0,8,0"/>
                        <TextBlock Text="How to Read the Results" FontWeight="Bold" Foreground="{StaticResource Brush.Primary}"/>
                    </StackPanel>
                    <TextBlock TextWrapping="Wrap" Margin="0,6,0,0">
                        Use the breadcrumb path and zoom percentage above the canvas to orient teammates. Nodes capture titles, notes, and owners; hover tooltips on connection points help explain how themes link together when exporting or presenting the map.
                    </TextBlock>
                </StackPanel>
            </Border>
            <Border Style="{StaticResource Border.ResultInfo}" Margin="0,12,0,0">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="" FontSize="18" Foreground="{StaticResource Brush.Primary}" Margin="0,0,8,0"/>
                        <TextBlock Text="Policy Notes" FontWeight="Bold" Foreground="{StaticResource Brush.Primary}"/>
                    </StackPanel>
                    <TextBlock TextWrapping="Wrap" Margin="0,6,0,0">
                        <Run Text=" Treat the canvas as working notesstore final decisions in the project file system per ER 5-1-11, Appendix C (pp. C-3C-5) records management."/>
                        <LineBreak/>
                        <Run Text=" Avoid capturing PII or procurement-sensitive details; reference secure SharePoint or RMS locations instead."/>
                        <LineBreak/>
                        <Run Text=" Export mind maps with meeting summaries so leadership sees the qualitative context behind quantitative analyses."/>
                    </TextBlock>
                </StackPanel>
            </Border>
        </StackPanel>
    </Grid>
</UserControl>
