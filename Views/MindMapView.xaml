<UserControl x:Class="EconToolbox.Desktop.Views.MindMapView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:EconToolbox.Desktop.ViewModels"
             xmlns:local="clr-namespace:EconToolbox.Desktop.Views"
             Background="{StaticResource Brush.SurfaceAlt}"
             SnapsToDevicePixels="True"
             UseLayoutRounding="True">
    <UserControl.Resources>
        <Style x:Key="ConnectionLineStyle" TargetType="Polyline">
            <Setter Property="Stroke" Value="#92A8D4"/>
            <Setter Property="StrokeThickness" Value="2.4"/>
            <Setter Property="StrokeStartLineCap" Value="Round"/>
            <Setter Property="StrokeEndLineCap" Value="Round"/>
            <Setter Property="StrokeLineJoin" Value="Round"/>
            <Setter Property="Opacity" Value="0.9"/>
            <Setter Property="Fill" Value="Transparent"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0"
                Style="{StaticResource Border.Explainer}"
                Margin="0,0,0,16"
                Padding="{StaticResource Padding.Card}">
            <StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <Viewbox Width="32" Height="32" Margin="0,0,10,0">
                        <Canvas Width="32" Height="32">
                            <Path Stroke="{StaticResource Brush.Primary}"
                                  StrokeThickness="2.4"
                                  StrokeLineJoin="Round"
                                  StrokeStartLineCap="Round"
                                  StrokeEndLineCap="Round">
                                <Path.Data>
                                    <GeometryGroup>
                                        <PathGeometry>
                                            <PathFigure StartPoint="12,8" IsClosed="False">
                                                <BezierSegment Point1="6,10" Point2="6,16" Point3="12,18"/>
                                                <BezierSegment Point1="6,20" Point2="6,26" Point3="12,28"/>
                                            </PathFigure>
                                        </PathGeometry>
                                        <PathGeometry>
                                            <PathFigure StartPoint="20,8" IsClosed="False">
                                                <BezierSegment Point1="26,10" Point2="26,16" Point3="20,18"/>
                                                <BezierSegment Point1="26,20" Point2="26,26" Point3="20,28"/>
                                            </PathFigure>
                                        </PathGeometry>
                                        <PathGeometry>
                                            <PathFigure StartPoint="12,12" IsClosed="False">
                                                <BezierSegment Point1="16,10" Point2="18,10" Point3="20,12"/>
                                            </PathFigure>
                                        </PathGeometry>
                                        <PathGeometry>
                                            <PathFigure StartPoint="12,16" IsClosed="False">
                                                <BezierSegment Point1="16,14" Point2="18,14" Point3="20,16"/>
                                            </PathFigure>
                                        </PathGeometry>
                                        <PathGeometry>
                                            <PathFigure StartPoint="12,20" IsClosed="False">
                                                <BezierSegment Point1="16,18" Point2="18,18" Point3="20,20"/>
                                            </PathFigure>
                                        </PathGeometry>
                                    </GeometryGroup>
                                </Path.Data>
                            </Path>
                        </Canvas>
                    </Viewbox>
                    <TextBlock Text="Mind Map Planner"
                               FontSize="18"
                               FontWeight="Bold"
                               Foreground="{StaticResource Brush.Primary}"/>
                </StackPanel>
                <TextBlock Margin="0,6,0,0"
                           TextWrapping="Wrap">
                    Right-click anywhere on the canvas to create new root, child, or sibling ideas. Drag the icons to
                    arrange your tree and use the panel on the right to fill in the details.
                </TextBlock>
            </StackPanel>
        </Border>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*"/>
                <ColumnDefinition Width="2*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0"
                    Background="{StaticResource Brush.Surface}"
                    CornerRadius="12"
                    Padding="18"
                    Margin="0,0,12,0"
                    BorderBrush="{StaticResource Brush.Border}"
                    BorderThickness="1">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0">
                        <TextBlock Text="Interactive Mind Map"
                                   FontSize="16"
                                   FontWeight="SemiBold"/>
                        <TextBlock Margin="0,4,0,0"
                                   Foreground="{StaticResource Brush.TextSecondary}"
                                   Text="Right-click to add ideas, and drag icons to re-arrange your thinking."/>
                        <StackPanel Orientation="Horizontal"
                                    Margin="0,10,0,0"
                                    VerticalAlignment="Center">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                ToolTip="Adjust to zoom the canvas in or out."/>
                                <TextBlock Text="Zoom"
                                           Margin="4,0,0,0"
                                           VerticalAlignment="Center"
                                           Foreground="{StaticResource Brush.TextSecondary}"/>
                            </StackPanel>
                            <Slider Width="160"
                                    Margin="10,0,0,0"
                                    Minimum="{Binding ZoomLevelMinimum}"
                                    Maximum="{Binding ZoomLevelMaximum}"
                                    Value="{Binding ZoomLevel, Mode=TwoWay}"
                                    TickFrequency="0.1"
                                    IsSnapToTickEnabled="False"
                                    SmallChange="0.05"
                                    LargeChange="0.2"
                                    VerticalAlignment="Center"
                                    ToolTip="Drag to change the zoom level of the mind map."/>
                            <TextBlock Text="{Binding ZoomLevel, StringFormat={}{0:P0}}"
                                       Margin="10,0,0,0"
                                       FontWeight="SemiBold"
                                       VerticalAlignment="Center"
                                       Foreground="{StaticResource Brush.Primary}"/>
                        </StackPanel>
                    </StackPanel>

                    <ScrollViewer Grid.Row="1"
                                  Margin="0,12,0,0"
                                  HorizontalScrollBarVisibility="Auto"
                                  VerticalScrollBarVisibility="Auto">
                        <Grid>
                            <Grid.LayoutTransform>
                                <ScaleTransform ScaleX="{Binding ZoomLevel}" ScaleY="{Binding ZoomLevel}"/>
                            </Grid.LayoutTransform>
                            <ItemsControl ItemsSource="{Binding Connections}"
                                          IsHitTestVisible="False"
                                          Panel.ZIndex="0">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas Width="{Binding CanvasWidth}"
                                                Height="{Binding CanvasHeight}"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="{x:Type vm:MindMapConnectionViewModel}">
                                        <Polyline Style="{StaticResource ConnectionLineStyle}"
                                                  Points="{Binding ConnectorPoints}"/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <ItemsControl x:Name="NodeItemsControl"
                                          ItemsSource="{Binding CanvasNodes}"
                                          Loaded="OnNodesLoaded"
                                          PreviewMouseRightButtonDown="OnCanvasRightButtonDown"
                                          Panel.ZIndex="1">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas Width="{Binding CanvasWidth}"
                                                Height="{Binding CanvasHeight}"
                                                Background="#F8FBFF"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemContainerStyle>
                                    <Style TargetType="ContentPresenter">
                                        <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                        <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                                    </Style>
                                </ItemsControl.ItemContainerStyle>
                                <ItemsControl.ContextMenu>
                                    <ContextMenu Opened="OnCanvasContextMenuOpened">
                                        <MenuItem Header="Add Root Idea"
                                                  Click="OnCanvasAddRoot"/>
                                        <MenuItem Header="Add Child Idea"
                                                  Click="OnCanvasAddChild"/>
                                        <MenuItem Header="Add Sibling Idea"
                                                  Click="OnCanvasAddSibling"/>
                                    </ContextMenu>
                                </ItemsControl.ContextMenu>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="{x:Type vm:MindMapNodeViewModel}">
                                        <Border Padding="12"
                                                Background="White"
                                                CornerRadius="18"
                                                BorderBrush="#CFDAED"
                                                BorderThickness="1.2"
                                                MouseLeftButtonDown="Node_MouseLeftButtonDown"
                                                MouseLeftButtonUp="Node_MouseLeftButtonUp"
                                                MouseMove="Node_MouseMove"
                                                MouseRightButtonDown="Node_MouseRightButtonDown"
                                                SizeChanged="Node_SizeChanged">
                                            <Border.Effect>
                                                <DropShadowEffect BlurRadius="14"
                                                                  ShadowDepth="3"
                                                                  Color="#1F3D66"
                                                                  Opacity="0.18"/>
                                            </Border.Effect>
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Opacity" Value="0.95"/>
                                                    <Setter Property="Cursor" Value="Hand"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                            <Setter Property="Opacity" Value="1"/>
                                                            <Setter Property="BorderBrush" Value="#2B6CB0"/>
                                                            <Setter Property="BorderThickness" Value="2.2"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <Border.ContextMenu>
                                                <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}"
                                                             Opened="OnNodeContextMenuOpened">
                                                    <MenuItem Header="Add Child"
                                                              Click="OnNodeAddChild"/>
                                                    <MenuItem Header="Add Sibling"
                                                              Click="OnNodeAddSibling"/>
                                                    <Separator/>
                                                    <MenuItem Header="Remove"
                                                              Click="OnNodeRemove"/>
                                                </ContextMenu>
                                            </Border.ContextMenu>
                                            <StackPanel Width="180">
                                                <Grid Width="64"
                                                      Height="64"
                                                      HorizontalAlignment="Center">
                                                    <Ellipse Fill="#E2ECFF"
                                                             Stroke="#9AB5E5"
                                                             StrokeThickness="1.4"/>
                                                    <TextBlock Text="💡"
                                                               FontSize="30"
                                                               FontFamily="Segoe UI Emoji"
                                                               VerticalAlignment="Center"
                                                               HorizontalAlignment="Center"/>
                                                </Grid>
                                                <TextBlock Text="{Binding Title}"
                                                           Margin="0,10,0,0"
                                                           FontWeight="SemiBold"
                                                           FontSize="14"
                                                           TextAlignment="Center"
                                                           Foreground="{StaticResource Brush.Primary}"
                                                           TextWrapping="Wrap"/>
                                                <TextBlock Text="{Binding Notes}"
                                                           Margin="0,6,0,0"
                                                           FontSize="12"
                                                           Foreground="{StaticResource Brush.TextSecondary}"
                                                           TextAlignment="Center"
                                                           TextTrimming="CharacterEllipsis"
                                                           TextWrapping="Wrap"
                                                           MaxHeight="48"/>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </ScrollViewer>
                </Grid>
            </Border>

            <Border Grid.Column="1"
                    Background="{StaticResource Brush.Surface}"
                    CornerRadius="12"
                    Padding="20"
                    BorderBrush="{StaticResource Brush.Border}"
                    BorderThickness="1">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0">
                        <TextBlock Text="Idea Details"
                                   FontSize="18"
                                   FontWeight="SemiBold"/>
                        <TextBlock Margin="0,4,0,12"
                                   TextWrapping="Wrap"
                                   Foreground="{StaticResource Brush.TextSecondary}"
                                   Text="Select an icon from the canvas to capture notes, context, and next steps."/>
                    </StackPanel>

                    <Border Grid.Row="1"
                            Background="{StaticResource Brush.HighlightBackground}"
                            BorderBrush="{StaticResource Brush.HighlightBorder}"
                            BorderThickness="1"
                            CornerRadius="8"
                            Padding="10"
                            Margin="0,0,0,12">
                        <TextBlock Text="{Binding SelectedPath}"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource Brush.Primary}"
                                   TextWrapping="Wrap">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding SelectedNode}" Value="{x:Null}">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Border>

                    <TextBlock Grid.Row="2"
                               Text="Right-click on the canvas to add your first idea."
                               VerticalAlignment="Center"
                               HorizontalAlignment="Center"
                               Foreground="{StaticResource Brush.TextSecondary}"
                               FontSize="14"
                               TextWrapping="Wrap"
                               TextAlignment="Center">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding SelectedNode}" Value="{x:Null}">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>

                    <ContentControl Grid.Row="2"
                                    Content="{Binding SelectedNode}">
                        <ContentControl.Style>
                            <Style TargetType="ContentControl">
                                <Setter Property="Visibility" Value="Visible"/>
                                <Style.Triggers>
                                    <Trigger Property="Content" Value="{x:Null}">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </ContentControl.Style>
                        <ContentControl.ContentTemplate>
                            <DataTemplate DataType="{x:Type vm:MindMapNodeViewModel}">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>

                                    <StackPanel Grid.Row="0" Margin="0,0,0,16">
                                        <TextBlock FontWeight="SemiBold">
                                            <InlineUIContainer BaselineAlignment="Center">
                                                <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                                ToolTip="Name this idea or topic as it should appear on the map."/>
                                            </InlineUIContainer>
                                            <Run Text="Idea Title"/>
                                        </TextBlock>
                                        <TextBox Text="{Binding Title, UpdateSourceTrigger=PropertyChanged}"
                                                 Margin="0,6,0,0"
                                                 MinHeight="28"/>
                                    </StackPanel>

                                    <StackPanel Grid.Row="1" Margin="0,0,0,16">
                                        <TextBlock FontWeight="SemiBold">
                                            <InlineUIContainer BaselineAlignment="Center">
                                                <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                                ToolTip="Capture supporting notes, context, or actions for the selected idea."/>
                                            </InlineUIContainer>
                                            <Run Text="Key Points / Notes"/>
                                        </TextBlock>
                                        <TextBox Text="{Binding Notes, UpdateSourceTrigger=PropertyChanged}"
                                                 Margin="0,6,0,0"
                                                 AcceptsReturn="True"
                                                 TextWrapping="Wrap"
                                                 Height="160"
                                                 VerticalScrollBarVisibility="Auto"/>
                                    </StackPanel>

                                    <Border Grid.Row="2"
                                            Background="{StaticResource Brush.SurfaceAlt}"
                                            BorderBrush="{StaticResource Brush.Border}"
                                            BorderThickness="1"
                                            CornerRadius="6"
                                            Padding="12">
                                        <StackPanel>
                                            <TextBlock Text="Child ideas"
                                                       FontWeight="SemiBold"
                                                       Margin="0,0,0,8"/>
                                            <ItemsControl ItemsSource="{Binding Children}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <StackPanel Orientation="Horizontal" Margin="0,2,0,2">
                                                            <TextBlock Text="•"
                                                                       FontSize="16"
                                                                       Margin="0,0,6,0"
                                                                       Foreground="{StaticResource Brush.Primary}"/>
                                                            <TextBlock Text="{Binding Title}"/>
                                                        </StackPanel>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                                <ItemsControl.Style>
                                                    <Style TargetType="ItemsControl">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Children.Count}" Value="0">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ItemsControl.Style>
                                            </ItemsControl>
                                            <TextBlock Text="No child ideas yet. Use the context menu to break this topic down further."
                                                       Foreground="{StaticResource Brush.TextSecondary}"
                                                       TextWrapping="Wrap">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Children.Count}" Value="0">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </StackPanel>
                                    </Border>
                                </Grid>
                            </DataTemplate>
                        </ContentControl.ContentTemplate>
                    </ContentControl>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>
