<UserControl x:Class="EconToolbox.Desktop.Views.EadView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:behaviors="clr-namespace:EconToolbox.Desktop.Behaviors"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             SnapsToDevicePixels="True"
             UseLayoutRounding="True">
    <Grid>
        <ScrollViewer Focusable="False"
                      HorizontalScrollBarVisibility="Disabled"
                      VerticalScrollBarVisibility="Auto"
                      Padding="{StaticResource Padding.Card}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <Border Grid.Row="0"
                        Style="{StaticResource Border.Explainer}">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="{StaticResource Margin.Stack}">
                            <TextBlock FontFamily="Segoe MDL2 Assets"
                                       Text=""
                                       FontSize="20"
                                       Foreground="{StaticResource Brush.Primary}"
                                       Margin="{StaticResource Margin.Inline}"/>
                            <TextBlock Text="Expected Annual Damage Instructions"
                                       FontWeight="Bold"
                                       FontSize="16"
                                       Foreground="{StaticResource Brush.Primary}"/>
                        </StackPanel>
                        <TextBlock Style="{StaticResource Text.Body}">
                            <Run Text="• List probability and damage values for each category. The curve automatically includes 0% and 100% anchors using trapezoidal interpolation."/>
                            <LineBreak/>
                            <Run Text="• Toggle Include Stage to capture paired stage values that align with the same probabilities."/>
                            <LineBreak/>
                            <Run Text="• Select Calculate after making edits so the charts, summary results, and exports refresh with your latest data."/>
                        </TextBlock>
                    </StackPanel>
                </Border>

                <WrapPanel Grid.Row="1"
                           Margin="{StaticResource Margin.StackLarge}"
                           ItemHeight="36"
                           ItemWidth="220"
                           MinWidth="200">
                    <WrapPanel.Style>
                        <Style TargetType="WrapPanel">
                            <Setter Property="ItemWidth" Value="220"/>
                            <Setter Property="ItemHeight" Value="36"/>
                            <Setter Property="HorizontalAlignment" Value="Stretch"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource WidthToLayoutModeConverter}}"
                                             Value="Narrow">
                                    <Setter Property="ItemWidth" Value="{x:Static sys:Double.NaN}"/>
                                    <Setter Property="ItemHeight" Value="{x:Static sys:Double.NaN}"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </WrapPanel.Style>
                    <Button Command="{Binding AddDamageColumnCommand}"
                            Margin="{StaticResource Margin.Inline}"
                            ToolTip="Append a new damage column for an additional category or scenario.">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="" Margin="{StaticResource Margin.Inline}"/>
                            <TextBlock Text="Add Damage Column"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding RemoveDamageColumnCommand}"
                            Margin="{StaticResource Margin.Inline}"
                            ToolTip="Remove the most recently added damage column.">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="" Margin="{StaticResource Margin.Inline}"/>
                            <TextBlock Text="Remove Damage Column"/>
                        </StackPanel>
                    </Button>
                    <CheckBox IsChecked="{Binding UseStage}"
                              VerticalAlignment="Center"
                              Margin="{StaticResource Margin.Inline}">
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <ContentControl Style="{StaticResource Content.InfoIcon}"
                                            ToolTip="Toggle to add a stage column so you can enter paired stage values."/>
                            <TextBlock Text="Include Stage" Margin="4,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>
                    </CheckBox>
                </WrapPanel>

                <UniformGrid Grid.Row="2"
                             Margin="{StaticResource Margin.StackLarge}">
                    <UniformGrid.Style>
                        <Style TargetType="UniformGrid">
                            <Setter Property="Columns" Value="1"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource WidthToLayoutModeConverter}}"
                                             Value="Wide">
                                    <Setter Property="Columns" Value="2"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </UniformGrid.Style>

                    <Border Background="{StaticResource Brush.Surface}"
                            CornerRadius="10"
                            Padding="{StaticResource Padding.Content}"
                            BorderBrush="{StaticResource Brush.Border}"
                            BorderThickness="1">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Margin" Value="0,0,0,16"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource WidthToLayoutModeConverter}}"
                                                 Value="Wide">
                                        <Setter Property="Margin" Value="0,0,16,0"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <StackPanel>
                            <TextBlock Text="Probability and Damage Inputs"
                                       FontWeight="SemiBold"
                                       Margin="0,0,0,12"/>
                            <DataGrid ItemsSource="{Binding Rows}"
                                      AutoGenerateColumns="False"
                                      CanUserAddRows="True"
                                      CanUserDeleteRows="True"
                                      ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                      Margin="0"
                                      behaviors:DataGridColumnsBehavior.ColumnsSource="{Binding ColumnDefinitions}"/>
                        </StackPanel>
                    </Border>

                    <Border Background="{StaticResource Brush.Surface}"
                            CornerRadius="10"
                            Padding="{StaticResource Padding.Content}"
                            BorderBrush="{StaticResource Brush.Border}"
                            BorderThickness="1">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Margin" Value="0"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource WidthToLayoutModeConverter}}"
                                                 Value="Wide">
                                        <Setter Property="Margin" Value="{StaticResource Margin.InlineLarge}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <StackPanel>
                            <TextBlock Text="Visualize Your Curve"
                                       FontWeight="SemiBold"
                                       Margin="{StaticResource Margin.Stack}"/>
                            <StackPanel Margin="{StaticResource Margin.Stack}">
                                <TextBlock Text="Customize chart labels"
                                           FontWeight="SemiBold"/>
                                <TextBlock Text="Update the chart title or override the axis labels shown on the visualization."
                                           Style="{StaticResource Text.Caption}"
                                           Margin="0,4,0,8"/>
                                <TextBox Text="{Binding ChartTitle, UpdateSourceTrigger=PropertyChanged}"
                                         MinWidth="200"
                                         Margin="0,0,0,6"
                                         ToolTip="Title shown above the EAD chart."/>
                                <UniformGrid Columns="2" Rows="1" Margin="0,0,0,0">
                                    <StackPanel Margin="0,0,8,0">
                                        <TextBlock Text="X-axis label" Style="{StaticResource Text.Caption}"/>
                                        <TextBox Text="{Binding CustomXAxisTitle, UpdateSourceTrigger=PropertyChanged}"
                                                 MinWidth="160"
                                                 ToolTip="Leave blank to use the suggested axis title."/>
                                    </StackPanel>
                                    <StackPanel Margin="8,0,0,0">
                                        <TextBlock Text="Y-axis label" Style="{StaticResource Text.Caption}"/>
                                        <TextBox Text="{Binding CustomYAxisTitle, UpdateSourceTrigger=PropertyChanged}"
                                                 MinWidth="160"
                                                 ToolTip="Leave blank to use the suggested axis title."/>
                                    </StackPanel>
                                </UniformGrid>
                            </StackPanel>
                            <Border Background="{StaticResource Brush.ChartFill}"
                                    BorderBrush="{StaticResource Brush.Border}"
                                    BorderThickness="1"
                                    CornerRadius="12"
                                    Padding="16"
                                    Margin="{StaticResource Margin.Stack}">
                                <Grid ClipToBounds="False">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    <TextBlock Text="{Binding ChartTitle}"
                                               Grid.Row="0"
                                               FontWeight="SemiBold"
                                               FontSize="14"
                                               TextAlignment="Center"
                                               Margin="0,0,0,8"/>
                                    <Grid Grid.Row="1">
                                        <Canvas x:Name="CurveCanvas" Width="420" Height="220" SnapsToDevicePixels="True">
                                            <Rectangle Width="420"
                                                       Height="220"
                                                       Fill="Transparent"
                                                       StrokeThickness="0"/>
                                            <Line X1="0" Y1="220" X2="420" Y2="220" Stroke="{StaticResource Brush.Border}" StrokeThickness="1"/>
                                            <Line X1="0" Y1="0" X2="0" Y2="220" Stroke="{StaticResource Brush.Border}" StrokeThickness="1"/>
                                            <Line X1="0" Y1="220" X2="0" Y2="214" Stroke="{StaticResource Brush.Border}" StrokeThickness="1"/>
                                            <Line X1="210" Y1="220" X2="210" Y2="214" Stroke="{StaticResource Brush.Border}" StrokeThickness="1"/>
                                            <Line X1="420" Y1="220" X2="420" Y2="214" Stroke="{StaticResource Brush.Border}" StrokeThickness="1"/>
                                            <Line X1="0" Y1="220" X2="6" Y2="220" Stroke="{StaticResource Brush.Border}" StrokeThickness="1"/>
                                            <Line X1="0" Y1="110" X2="6" Y2="110" Stroke="{StaticResource Brush.Border}" StrokeThickness="1"/>
                                            <Line X1="0" Y1="0" X2="6" Y2="0" Stroke="{StaticResource Brush.Border}" StrokeThickness="1"/>
                                            <Line X1="0" Y1="165" X2="420" Y2="165" Stroke="{StaticResource Brush.ChartGrid}" StrokeThickness="1" StrokeDashArray="4 6"/>
                                            <Line X1="0" Y1="110" X2="420" Y2="110" Stroke="{StaticResource Brush.ChartGrid}" StrokeThickness="1" StrokeDashArray="4 6"/>
                                            <Line X1="0" Y1="55" X2="420" Y2="55" Stroke="{StaticResource Brush.ChartGrid}" StrokeThickness="1" StrokeDashArray="4 6"/>
                                            <Line X1="105" Y1="0" X2="105" Y2="220" Stroke="{StaticResource Brush.ChartGrid}" StrokeThickness="1" StrokeDashArray="4 6"/>
                                            <Line X1="210" Y1="0" X2="210" Y2="220" Stroke="{StaticResource Brush.ChartGrid}" StrokeThickness="1" StrokeDashArray="4 6"/>
                                            <Line X1="315" Y1="0" X2="315" Y2="220" Stroke="{StaticResource Brush.ChartGrid}" StrokeThickness="1" StrokeDashArray="4 6"/>
                                        </Canvas>
                                        <ItemsControl ItemsSource="{Binding DamageSeries}" IsHitTestVisible="False">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <Canvas Width="420" Height="220"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Polyline Points="{Binding Points}"
                                                              Stroke="{Binding Stroke}"
                                                              StrokeThickness="3"
                                                              StrokeEndLineCap="Round"
                                                              StrokeStartLineCap="Round"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                        <TextBlock Text="{Binding XAxisMinLabel}"
                                                   HorizontalAlignment="Left"
                                                   VerticalAlignment="Bottom"
                                                   Margin="12,0,0,10"
                                                   FontSize="11"
                                                   Foreground="{StaticResource Brush.TextSecondary}"/>
                                        <TextBlock Text="{Binding XAxisMidLabel}"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Bottom"
                                                   Margin="0,0,0,10"
                                                   FontSize="11"
                                                   Foreground="{StaticResource Brush.TextSecondary}"/>
                                        <TextBlock Text="{Binding XAxisMaxLabel}"
                                                   HorizontalAlignment="Right"
                                                   VerticalAlignment="Bottom"
                                                   Margin="0,0,12,10"
                                                   FontSize="11"
                                                   Foreground="{StaticResource Brush.TextSecondary}"/>
                                        <TextBlock Text="{Binding YAxisMinLabel}"
                                                   HorizontalAlignment="Left"
                                                   VerticalAlignment="Bottom"
                                                   Margin="14,0,0,34"
                                                   FontSize="11"
                                                   Foreground="{StaticResource Brush.TextSecondary}"/>
                                        <TextBlock Text="{Binding YAxisMidLabel}"
                                                   HorizontalAlignment="Left"
                                                   VerticalAlignment="Center"
                                                   Margin="14,0,0,0"
                                                   FontSize="11"
                                                   Foreground="{StaticResource Brush.TextSecondary}"/>
                                        <TextBlock Text="{Binding YAxisMaxLabel}"
                                                   HorizontalAlignment="Left"
                                                   VerticalAlignment="Top"
                                                   Margin="14,12,0,0"
                                                   FontSize="11"
                                                   Foreground="{StaticResource Brush.TextSecondary}"/>
                                        <TextBlock Text="{Binding XAxisTitle}"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Bottom"
                                                   Margin="0,0,0,-6"
                                                   FontWeight="SemiBold"
                                                   FontSize="12"
                                                   Foreground="{StaticResource Brush.TextPrimary}"/>
                                        <TextBlock Text="{Binding YAxisTitle}"
                                                   HorizontalAlignment="Left"
                                                   VerticalAlignment="Center"
                                                   Margin="-14,0,0,0"
                                                   FontWeight="SemiBold"
                                                   FontSize="12"
                                                   Foreground="{StaticResource Brush.TextPrimary}">
                                            <TextBlock.RenderTransform>
                                                <RotateTransform Angle="-90" CenterX="0" CenterY="0"/>
                                            </TextBlock.RenderTransform>
                                        </TextBlock>
                                    </Grid>
                                </Grid>
                            </Border>
                            <ItemsControl ItemsSource="{Binding DamageSeries}" Margin="{StaticResource Margin.Stack}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel IsItemsHost="True" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,12,6">
                                            <Rectangle Width="12"
                                                       Height="12"
                                                       RadiusX="2"
                                                       RadiusY="2"
                                                       Fill="{Binding Stroke}"
                                                       StrokeThickness="0.5"
                                                       Stroke="{StaticResource Brush.Border}"/>
                                            <TextBlock Text="{Binding Name}"
                                                       Margin="6,0,0,0"
                                                       Style="{StaticResource Text.Caption}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            <TextBlock Style="{StaticResource Text.Caption}" TextWrapping="Wrap">
                                Damages are plotted against stage when stage values are supplied; otherwise, the curve uses exceedance probability on the x-axis.
                            </TextBlock>
                        </StackPanel>
                    </Border>
                </UniformGrid>

                <Border Grid.Row="3"
                        Margin="{StaticResource Margin.StackLarge}"
                        Background="{StaticResource Brush.Surface}"
                        BorderBrush="{StaticResource Brush.Border}"
                        BorderThickness="1"
                        CornerRadius="10"
                        Padding="{StaticResource Padding.Card}">
                    <StackPanel>
                        <TextBlock Text="Expected Annual Damage Results"
                                   FontWeight="SemiBold"
                                   Margin="0,0,0,8"/>
                        <DataGrid ItemsSource="{Binding Results}"
                                  AutoGenerateColumns="False"
                                  CanUserAddRows="False"
                                  CanUserDeleteRows="False"
                                  HeadersVisibility="Column"
                                  IsReadOnly="True"
                                  Margin="0,4,0,0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Damage Column"
                                                    Binding="{Binding Label}"
                                                    Width="*"/>
                                <DataGridTextColumn Header="Expected Annual Damage"
                                                    Binding="{Binding Result}"
                                                    Width="220"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </StackPanel>
                </Border>

                <StackPanel Grid.Row="4" Margin="{StaticResource Margin.StackLarge}">
                    <Border Style="{StaticResource Border.ResultInfo}">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <TextBlock FontFamily="Segoe MDL2 Assets"
                                           Text=""
                                           FontSize="18"
                                           Foreground="{StaticResource Brush.Primary}"
                                           Margin="0,0,8,0"/>
                                <TextBlock Text="How to Read the Results"
                                           FontWeight="Bold"
                                           Foreground="{StaticResource Brush.Primary}"/>
                            </StackPanel>
                            <TextBlock Style="{StaticResource Text.Body}" TextWrapping="Wrap" Margin="0,6,0,0">
                                Each Expected Annual Damage value averages the damage column across the entire probability curve you supplied. Higher damages at frequent events raise the EAD most dramatically. The plotted curves update with every calculation, helping you confirm the shape of the frequency and stage relationships before exporting your Excel summary.
                            </TextBlock>
                        </StackPanel>
                    </Border>
                    <Border Style="{StaticResource Border.ResultInfo}" Margin="0,12,0,0">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <TextBlock FontFamily="Segoe MDL2 Assets"
                                           Text=""
                                           FontSize="18"
                                           Foreground="{StaticResource Brush.Primary}"
                                           Margin="0,0,8,0"/>
                                <TextBlock Text="Policy Notes"
                                           FontWeight="Bold"
                                           Foreground="{StaticResource Brush.Primary}"/>
                            </StackPanel>
                            <TextBlock Style="{StaticResource Text.Body}" TextWrapping="Wrap" Margin="0,6,0,0">
                                <Run Text="• Document sources for stage-frequency and damage data in accordance with ER 1105-2-100, Chapter 2 (Section 2-3, pp. 2-14–2-20) economic evaluation requirements."/>
                                <LineBreak/>
                                <Run Text="• Coordinate curve assumptions with hydraulics and economics PDT leads before releasing EAD figures for decision documents (ER 1105-2-100, Appendix D, pp. D-14–D-22)."/>
                                <LineBreak/>
                                <Run Text="• Archive exported tables and charts within the district quality management system (ER 5-1-11, Appendix C, pp. C-3–C-5) so reviewers can trace updates."/>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                    <Border Style="{StaticResource Border.ResultInfo}" Margin="0,12,0,0">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <TextBlock FontFamily="Segoe MDL2 Assets"
                                           Text=""
                                           FontSize="18"
                                           Foreground="{StaticResource Brush.Primary}"
                                           Margin="0,0,8,0"/>
                                <TextBlock Text="Formula Reference"
                                           FontWeight="Bold"
                                           Foreground="{StaticResource Brush.Primary}"/>
                            </StackPanel>
                            <TextBlock Style="{StaticResource Text.Body}" TextWrapping="Wrap" Margin="0,6,0,0">
                                <Run Text="• Input rows are ordered by exceedance probability p, then the tool inserts anchors at p = 1 with damage = 0 and at p = 0 with damage equal to the maximum entered value."/>
                                <LineBreak/>
                                <Run Text="• Expected Annual Damage is integrated with the trapezoidal rule: EAD = Σ 0.5 × (dᵢ + dᵢ₊₁) × (pᵢ − pᵢ₊₁)."/>
                                <LineBreak/>
                                <Run Text="• Stage and frequency curves plot the same damage values against their paired probabilities or stages for visual QA/QC."/>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Grid>
        </ScrollViewer>
    </Grid>
</UserControl>
