<UserControl x:Class="EconToolbox.Desktop.Views.EadView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:behaviors="clr-namespace:EconToolbox.Desktop.Behaviors"
             xmlns:controls="clr-namespace:EconToolbox.Desktop.Views.Controls"
             xmlns:sys="clr-namespace:System;assembly=System.Runtime"
             Background="{DynamicResource App.SurfaceAlt}"
             SnapsToDevicePixels="True"
             UseLayoutRounding="True">
    <Grid>
        <ScrollViewer Style="{StaticResource ScrollViewer.Page}">
            <StackPanel Style="{StaticResource Layout.ContentStack}">
                <Border Style="{StaticResource Border.Explainer}">
                    <StackPanel>
                        <Grid VerticalAlignment="Center">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Text=""
                                       Style="{StaticResource Text.Icon.Section}"/>
                            <TextBlock Grid.Column="1"
                                       Text="Expected Annual Damage"
                                       Style="{StaticResource Text.SectionTitleAccent}"
                                       TextWrapping="Wrap"/>
                        </Grid>
                        <TextBlock TextWrapping="Wrap"
                                   Style="{StaticResource Text.Body}"
                                   Margin="{StaticResource Margin.TopLarge}">
                            Add stage/frequency and damage values for each category, then use the buttons below to compare scenarios and visualize the curves. Select Calculate after updates so the chart and summary outputs stay synchronized.
                        </TextBlock>
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource Border.Card}"
                        Margin="0,0,0,12">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                            <Button Command="{Binding AddDamageColumnCommand}"
                                    Style="{StaticResource Button.Action}"
                                    Margin="0,0,12,0"
                                    ToolTip="Append a new damage column for an additional category or scenario. Additional columns create new damage curves included in calculations.">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <TextBlock Text="" Style="{StaticResource Text.Icon.Action}"/>
                                    <TextBlock Text="Add Damage Column"/>
                                </StackPanel>
                            </Button>
                            <Button Command="{Binding RemoveDamageColumnCommand}"
                                    Style="{StaticResource Button.Action}"
                                    Margin="0,0,12,0"
                                    ToolTip="Remove the most recently added damage column. Removing a column excludes its damage curve from calculations.">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <TextBlock Text="" Style="{StaticResource Text.Icon.Action}"/>
                                    <TextBlock Text="Remove Damage Column"/>
                                </StackPanel>
                            </Button>
                            <CheckBox IsChecked="{Binding UseStage}"
                                      VerticalAlignment="Center"
                                      Content="Include Stage"
                                      Margin="0,0,12,0"
                                      ToolTip="Toggle to add a stage column so you can enter paired stage values. Stage values change how damages align with stage-frequency logic."/>
                            <CheckBox IsChecked="{Binding CalculateEqad}"
                                      VerticalAlignment="Center"
                                      Content="Calculate EqAD"
                                      ToolTip="Enable equivalent expected annual damage (EqAD) using an analysis period and future damages per USACE guidance."/>
                        </StackPanel>
                        <Grid Margin="0,12,0,0"
                              Visibility="{Binding CalculateEqad, Converter={StaticResource BoolToVisibilityConverter}}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="180"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="180"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0"
                                       Text="Analysis Period (Years)"
                                       VerticalAlignment="Center"
                                       Margin="0,0,12,0"/>
                            <TextBox Grid.Column="1"
                                     Text="{Binding AnalysisPeriod, Converter={StaticResource SafeNumberConverter}}"
                                     HorizontalContentAlignment="Right"
                                     Style="{StaticResource Form.TextBoxWide}"
                                     ToolTip="Number of years used to annualize future damages when calculating EqAD."/>
                            <TextBlock Grid.Column="2"
                                       Text="Future Damages"
                                       VerticalAlignment="Center"
                                       Margin="24,0,12,0"/>
                            <TextBox Grid.Column="3"
                                     Text="{Binding FutureDamages, Converter={StaticResource SafeNumberConverter}}"
                                     HorizontalContentAlignment="Right"
                                     Style="{StaticResource Form.TextBoxWide}"
                                     ToolTip="Total expected future damages to annualize across the analysis period for EqAD."/>
                        </Grid>
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource Border.Card}"
                        Margin="0,0,0,12">
                    <StackPanel>
                        <TextBlock Text="Stage / Frequency / Damage Inputs"
                                   Style="{StaticResource Text.SectionTitle}"
                                   Margin="{StaticResource Margin.StackLarge}"/>
                        <DataGrid CanUserResizeColumns="True" ItemsSource="{Binding Rows}"
                                  AutoGenerateColumns="False"
                                  CanUserAddRows="True"
                                  CanUserDeleteRows="True"
                                  HeadersVisibility="Column"
                                  ColumnWidth="SizeToHeader"
                                  ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                  Margin="0"
                                  behaviors:DataGridColumnsBehavior.ColumnsSource="{Binding ColumnDefinitions}"/>
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource Border.Card}"
                        Margin="0,0,0,12">
                    <StackPanel>
                        <TextBox Text="{Binding ChartTitle, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 FontSize="16"
                                 FontWeight="SemiBold"
                                 HorizontalAlignment="Left"
                                 Margin="0,0,0,12"
                                 BorderThickness="0"
                                 Background="Transparent"
                                 ToolTip="Title shown above the frequency-damage chart and included in exports."
                                 TextAlignment="Left"
                                 HorizontalContentAlignment="Left"/>
                        <TextBlock Text="Graph shows frequency-damage or stage-damage curves for each column so you can visually confirm the inputs."
                                   Style="{StaticResource Text.BodySmall}"
                                   Margin="0,0,0,12"/>
                        <ItemsControl ItemsSource="{Binding LegendItems}"
                                      Margin="0,0,0,12">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,12,4">
                                        <Ellipse Width="12"
                                                 Height="12"
                                                 Fill="{Binding Color}"
                                                 Stroke="{DynamicResource App.Border}"
                                                 StrokeThickness="0.5"
                                                 Margin="0,0,6,0"/>
                                        <TextBlock Text="{Binding Name}"
                                                   VerticalAlignment="Center"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        <Border Style="{StaticResource Border.Panel}"
                                Background="{DynamicResource App.ChartFill}"
                                BorderBrush="{DynamicResource App.Border}"
                                BorderThickness="1"
                                CornerRadius="8"
                                Padding="8"
                                HorizontalAlignment="Stretch">
                            <controls:LineGraphControl Height="420"
                                                       MinHeight="320"
                                                       HorizontalAlignment="Stretch"
                                                       Series="{Binding ChartSeries}"
                                                       IsStageAxis="{Binding UseStage}"
                                                       EmptyMessage="{Binding ChartStatusMessage}"/>
                        </Border>
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource Border.Card}">
                    <StackPanel>
                        <TextBlock Text="Expected Annual Damage Results"
                                   Style="{StaticResource Text.SectionTitle}"
                                   Margin="0,0,0,8"/>
                        <DataGrid CanUserResizeColumns="True" ItemsSource="{Binding Results}"
                                  AutoGenerateColumns="False"
                                  CanUserAddRows="False"
                                  CanUserDeleteRows="False"
                                  HeadersVisibility="Column"
                                  IsReadOnly="True"
                                  ColumnWidth="SizeToHeader">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Damage Column"
                                                    Binding="{Binding Label}"
                                                    Width="SizeToHeader">
                                    <DataGridTextColumn.HeaderStyle>
                                        <Style TargetType="DataGridColumnHeader">
                                            <Setter Property="ToolTip" Value="Name of the damage column or category summarized in the results table."/>
                                        </Style>
                                    </DataGridTextColumn.HeaderStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Expected Annual Damage"
                                                    Binding="{Binding Result}"
                                                    Width="SizeToHeader">
                                    <DataGridTextColumn.HeaderStyle>
                                        <Style TargetType="DataGridColumnHeader">
                                            <Setter Property="ToolTip" Value="Calculated expected annual damage for the column, based on the integrated frequency-damage curve."/>
                                        </Style>
                                    </DataGridTextColumn.HeaderStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Equivalent Annual Damage (EqAD)"
                                                    Binding="{Binding EqadResult}"
                                                    Width="SizeToHeader"
                                                    Visibility="{Binding DataContext.CalculateEqad, RelativeSource={RelativeSource AncestorType=DataGrid}, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <DataGridTextColumn.HeaderStyle>
                                        <Style TargetType="DataGridColumnHeader">
                                            <Setter Property="ToolTip" Value="Equivalent expected annual damages that combine EAD with annualized future damages."/>
                                        </Style>
                                    </DataGridTextColumn.HeaderStyle>
                                </DataGridTextColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
