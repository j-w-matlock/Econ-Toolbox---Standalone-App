<UserControl x:Class="EconToolbox.Desktop.Views.WaterDemandView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="clr-namespace:EconToolbox.Desktop.Views.Controls"
             x:Name="Root"
             Background="{StaticResource Brush.SurfaceAlt}"
             SnapsToDevicePixels="True"
             UseLayoutRounding="True">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Themes/Design.xaml"/>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>
    <ScrollViewer VerticalScrollBarVisibility="Auto"
                  HorizontalScrollBarVisibility="Auto"
                  Padding="{StaticResource Padding.Card}">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <Border Grid.Row="0"
                    Style="{StaticResource Border.Explainer}"
                    Margin="0,0,0,12">
                <StackPanel>
                    <Grid VerticalAlignment="Center">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock FontFamily="Segoe MDL2 Assets"
                                   Text=""
                                   FontSize="18"
                                   Foreground="{StaticResource Brush.Primary}"
                                   Margin="0,0,8,0"/>
                        <TextBlock Grid.Column="1"
                                   Text="Water Demand Forecast Workflow"
                                   FontWeight="Bold"
                                   FontSize="16"
                                   Foreground="{StaticResource Brush.Primary}"
                                   TextWrapping="Wrap"/>
                    </Grid>
                    <TextBlock TextWrapping="Wrap"
                               Margin="0,6,0,0">
                        <Run Text="• Enter historic demand records first to calibrate the baseline."/>
                        <LineBreak/>
                        <Run Text="• Choose or add scenarios, then set the forecast horizon and demographic assumptions."/>
                        <LineBreak/>
                        <Run Text="• Use Calculate and Export after edits so scenario charts, tables, and workbooks stay current."/>
                    </TextBlock>
                </StackPanel>
            </Border>
            <TabControl Grid.Row="1" ItemsSource="{Binding Scenarios}" SelectedItem="{Binding SelectedScenario}" HorizontalContentAlignment="Stretch">
                <TabControl.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding Name}" ToolTip="{Binding Description}"/>
                    </DataTemplate>
                </TabControl.ItemTemplate>
                <TabControl.ContentTemplate>
                    <DataTemplate>
                        <Grid x:Name="ScenarioLayout">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid Grid.Row="0">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="2*"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <Border Grid.Row="0"
                                        Background="{StaticResource Brush.Surface}"
                                        BorderBrush="{StaticResource Brush.Border}"
                                        BorderThickness="1"
                                        CornerRadius="8"
                                        Padding="12"
                                        Margin="0,0,0,8">
                                    <StackPanel>
                                        <TextBlock Text="Historical Demand"
                                                   FontWeight="SemiBold"
                                                   Margin="0,0,0,12"/>
                                        <DataGrid ItemsSource="{Binding DataContext.HistoricalData, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                  AutoGenerateColumns="False"
                                                  HorizontalAlignment="Stretch"
                                                  VerticalAlignment="Stretch"
                                                  ScrollViewer.VerticalScrollBarVisibility="Auto"
                                                  ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                                  Margin="0">
                                            <DataGrid.Columns>
                                            <DataGridTextColumn Binding="{Binding Year}">
                                                <DataGridTextColumn.Header>
                                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                        <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                                        ToolTip="Historical observation year for the demand record."/>
                                                        <TextBlock Text="Year" Margin="4,0,0,0" VerticalAlignment="Center"/>
                                                    </StackPanel>
                                                </DataGridTextColumn.Header>
                                            </DataGridTextColumn>
                                            <DataGridTextColumn Binding="{Binding Demand}">
                                                <DataGridTextColumn.Header>
                                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                        <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                                        ToolTip="Recorded water demand per capita for the listed year."/>
                                                        <TextBlock Text="Demand per Capita" Margin="4,0,0,0" VerticalAlignment="Center"/>
                                                    </StackPanel>
                                                </DataGridTextColumn.Header>
                                            </DataGridTextColumn>
                                        </DataGrid.Columns>
                                        </DataGrid>
                                    </StackPanel>
                                </Border>
                                <Grid Grid.Row="1" Margin="0,0,0,5" VerticalAlignment="Top" HorizontalAlignment="Stretch">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.Resources>
                                        <Style TargetType="TextBox">
                                            <Setter Property="MinWidth" Value="120"/>
                                            <Setter Property="HorizontalAlignment" Value="Stretch"/>
                                            <Setter Property="Margin" Value="0,0,10,0"/>
                                        </Style>
                                    </Grid.Resources>

                                    <TextBlock Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" Margin="0,0,5,0">
                                        <InlineUIContainer BaselineAlignment="Center">
                                            <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                            ToolTip="Number of years to extend the demand projection."/>
                                        </InlineUIContainer>
                                        <Run Text="Forecast Years"/>
                                    </TextBlock>
                                    <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding DataContext.ForecastYears, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                    <TextBlock Text="years" Grid.Row="0" Grid.Column="2" VerticalAlignment="Center"/>

                                    <TextBlock Grid.Row="1" Grid.Column="0" VerticalAlignment="Center" Margin="0,0,5,0">
                                        <InlineUIContainer BaselineAlignment="Center">
                                            <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                            ToolTip="Year that anchors the historical data and forecast."/>
                                        </InlineUIContainer>
                                        <Run Text="Base Year"/>
                                    </TextBlock>
                                    <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding BaseYear}"/>

                                    <TextBlock Grid.Row="2" Grid.Column="0" VerticalAlignment="Center" Margin="0,0,5,0">
                                        <InlineUIContainer BaselineAlignment="Center">
                                            <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                            ToolTip="Population served in the base year."/>
                                        </InlineUIContainer>
                                        <Run Text="Base Population"/>
                                    </TextBlock>
                                    <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding BasePopulation}"/>
                                    <TextBlock Text="people" Grid.Row="2" Grid.Column="2" VerticalAlignment="Center"/>

                                    <TextBlock Grid.Row="3" Grid.Column="0" VerticalAlignment="Center" Margin="0,0,5,0">
                                        <InlineUIContainer BaselineAlignment="Center">
                                            <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                            ToolTip="Current per capita water demand for the base year."/>
                                        </InlineUIContainer>
                                        <Run Text="Base Per Capita"/>
                                    </TextBlock>
                                    <TextBox Grid.Row="3" Grid.Column="1" Text="{Binding BasePerCapitaDemand}"/>
                                    <TextBlock Text="gallons/person/day" Grid.Row="3" Grid.Column="2" VerticalAlignment="Center"/>

                                    <TextBlock Grid.Row="4" Grid.Column="0" VerticalAlignment="Center" Margin="0,0,5,0">
                                        <InlineUIContainer BaselineAlignment="Center">
                                            <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                            ToolTip="Expected annual population growth rate for the service area."/>
                                        </InlineUIContainer>
                                        <Run Text="Population Growth %"/>
                                    </TextBlock>
                                    <TextBox Grid.Row="4" Grid.Column="1" Text="{Binding PopulationGrowthRate}"/>
                                    <TextBlock Text="%" Grid.Row="4" Grid.Column="2" VerticalAlignment="Center"/>

                                    <TextBlock Grid.Row="5" Grid.Column="0" VerticalAlignment="Center" Margin="0,0,5,0">
                                        <InlineUIContainer BaselineAlignment="Center">
                                            <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                            ToolTip="Annual percentage change expected in per capita demand."/>
                                        </InlineUIContainer>
                                        <Run Text="Per Capita Change %"/>
                                    </TextBlock>
                                    <TextBox Grid.Row="5" Grid.Column="1" Text="{Binding PerCapitaDemandChangeRate}"/>
                                    <TextBlock Text="%" Grid.Row="5" Grid.Column="2" VerticalAlignment="Center"/>

                                    <DataGrid Grid.Row="6" Grid.ColumnSpan="3" ItemsSource="{Binding Sectors}" AutoGenerateColumns="False" CanUserAddRows="False" HeadersVisibility="Column" Margin="0,5,0,5">
                                        <DataGrid.Columns>
                                            <DataGridTextColumn Header="Sector" Binding="{Binding Name}" IsReadOnly="True"/>
                                            <DataGridTextColumn Binding="{Binding CurrentPercent, Mode=TwoWay}">
                                                <DataGridTextColumn.Header>
                                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                        <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                                        ToolTip="Current share of total demand attributed to the sector."/>
                                                        <TextBlock Text="Current %" Margin="4,0,0,0" VerticalAlignment="Center"/>
                                                    </StackPanel>
                                                </DataGridTextColumn.Header>
                                            </DataGridTextColumn>
                                            <DataGridTextColumn Binding="{Binding FuturePercent, Mode=TwoWay}">
                                                <DataGridTextColumn.Header>
                                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                        <ContentControl Style="{StaticResource Content.InfoIcon}"
                                                                        ToolTip="Projected future share of total demand for the sector."/>
                                                        <TextBlock Text="Future %" Margin="4,0,0,0" VerticalAlignment="Center"/>
                                                    </StackPanel>
                                                </DataGridTextColumn.Header>
                                            </DataGridTextColumn>
                                        </DataGrid.Columns>
                                    </DataGrid>

                                    <Expander Grid.Row="7" Grid.ColumnSpan="3" Header="Advanced Adjustments" Margin="0,5,0,5">
                                        <Grid Margin="0,4,0,0" Grid.IsSharedSizeScope="True">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" SharedSizeGroup="InfoIcon"/>
                                                <ColumnDefinition Width="Auto" SharedSizeGroup="Label"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            <ContentControl Grid.Row="0"
                                                            Grid.Column="0"
                                                            Style="{StaticResource Content.InfoIcon}"
                                                            ToolTip="Percent reduction in demand from planned system improvements."/>
                                            <TextBlock Grid.Row="0"
                                                       Grid.Column="1"
                                                       Text="Improvements %"
                                                       Margin="4,0,0,0"
                                                       VerticalAlignment="Center"/>
                                            <TextBox Grid.Row="0"
                                                     Grid.Column="2"
                                                     Margin="12,0,0,0"
                                                     Text="{Binding SystemImprovementsPercent}"/>
                                            <ContentControl Grid.Row="1"
                                                            Grid.Column="0"
                                                            Style="{StaticResource Content.InfoIcon}"
                                                            ToolTip="Percent of demand lost to system leakage or other losses."/>
                                            <TextBlock Grid.Row="1"
                                                       Grid.Column="1"
                                                       Text="Losses %"
                                                       Margin="4,6,0,0"
                                                       VerticalAlignment="Center"/>
                                            <TextBox Grid.Row="1"
                                                     Grid.Column="2"
                                                     Margin="12,6,0,0"
                                                     Text="{Binding SystemLossesPercent}"/>
                                        </Grid>
                                    </Expander>

                                    <Border Grid.Row="8" Grid.ColumnSpan="3" Background="{StaticResource Brush.ChartFill}" BorderBrush="{StaticResource Brush.Border}" BorderThickness="1" CornerRadius="8" Padding="12" Margin="0,8,0,0">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Name}" Value="Baseline">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <Grid Grid.IsSharedSizeScope="True">
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" SharedSizeGroup="ScenarioLabel"/>
                                                <ColumnDefinition Width="Auto" SharedSizeGroup="ScenarioValue"/>
                                                <ColumnDefinition Width="Auto" SharedSizeGroup="ScenarioValue"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="3" FontWeight="SemiBold" Foreground="{StaticResource Brush.Primary}" Margin="0,0,0,8" Text="Scenario Variations (% change applied to baseline rates)"/>
                                            <TextBlock Grid.Row="1" Grid.Column="0" FontWeight="SemiBold" Foreground="{StaticResource Brush.TextSecondary}" Text="Parameter"/>
                                            <TextBlock Grid.Row="1" Grid.Column="1" FontWeight="SemiBold" Foreground="{StaticResource Brush.TextSecondary}" Margin="16,0,16,0" Text="Alternative Forecast 1" HorizontalAlignment="Left"/>
                                            <TextBlock Grid.Row="1" Grid.Column="2" FontWeight="SemiBold" Foreground="{StaticResource Brush.TextSecondary}" Text="Alternative Forecast 2" HorizontalAlignment="Left"/>

                                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Population growth"/>
                                            <TextBox Grid.Row="2" Grid.Column="1" MinWidth="90" HorizontalAlignment="Left" TextAlignment="Center" Text="{Binding DataContext.Alternative1PopulationAdjustment, RelativeSource={RelativeSource AncestorType=UserControl}}" ToolTip="Percent change applied to baseline population growth rate for Alternative Forecast 1."/>
                                            <TextBox Grid.Row="2" Grid.Column="2" MinWidth="90" HorizontalAlignment="Left" TextAlignment="Center" Text="{Binding DataContext.Alternative2PopulationAdjustment, RelativeSource={RelativeSource AncestorType=UserControl}}" ToolTip="Percent change applied to baseline population growth rate for Alternative Forecast 2."/>

                                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Per capita demand change"/>
                                            <TextBox Grid.Row="3" Grid.Column="1" MinWidth="90" HorizontalAlignment="Left" Margin="0,4,0,0" TextAlignment="Center" Text="{Binding DataContext.Alternative1PerCapitaAdjustment, RelativeSource={RelativeSource AncestorType=UserControl}}" ToolTip="Percent change applied to baseline per capita demand change rate for Alternative Forecast 1."/>
                                            <TextBox Grid.Row="3" Grid.Column="2" MinWidth="90" HorizontalAlignment="Left" Margin="0,4,0,0" TextAlignment="Center" Text="{Binding DataContext.Alternative2PerCapitaAdjustment, RelativeSource={RelativeSource AncestorType=UserControl}}" ToolTip="Percent change applied to baseline per capita demand change rate for Alternative Forecast 2."/>

                                            <TextBlock Grid.Row="4" Grid.Column="0" Text="System improvements"/>
                                            <TextBox Grid.Row="4" Grid.Column="1" MinWidth="90" HorizontalAlignment="Left" Margin="0,4,0,0" TextAlignment="Center" Text="{Binding DataContext.Alternative1ImprovementsAdjustment, RelativeSource={RelativeSource AncestorType=UserControl}}" ToolTip="Percent change applied to baseline system improvements for Alternative Forecast 1."/>
                                            <TextBox Grid.Row="4" Grid.Column="2" MinWidth="90" HorizontalAlignment="Left" Margin="0,4,0,0" TextAlignment="Center" Text="{Binding DataContext.Alternative2ImprovementsAdjustment, RelativeSource={RelativeSource AncestorType=UserControl}}" ToolTip="Percent change applied to baseline system improvements for Alternative Forecast 2."/>

                                            <TextBlock Grid.Row="5" Grid.Column="0" Text="System losses"/>
                                            <TextBox Grid.Row="5" Grid.Column="1" MinWidth="90" HorizontalAlignment="Left" Margin="0,4,0,0" TextAlignment="Center" Text="{Binding DataContext.Alternative1LossesAdjustment, RelativeSource={RelativeSource AncestorType=UserControl}}" ToolTip="Percent change applied to baseline system losses for Alternative Forecast 1."/>
                                            <TextBox Grid.Row="5" Grid.Column="2" MinWidth="90" HorizontalAlignment="Left" Margin="0,4,0,0" TextAlignment="Center" Text="{Binding DataContext.Alternative2LossesAdjustment, RelativeSource={RelativeSource AncestorType=UserControl}}" ToolTip="Percent change applied to baseline system losses for Alternative Forecast 2."/>

                                            <TextBlock Grid.Row="6" Grid.Column="0" Grid.ColumnSpan="3" Margin="0,10,0,0" FontSize="12" Foreground="{StaticResource Brush.TextSecondary}" TextWrapping="Wrap">
                                                Adjust the percentage change applied to each baseline rate to craft two alternative forecasts. Positive values increase the rate, while negative values decrease it. Baseline inputs remain unchanged.
                                            </TextBlock>
                                        </Grid>
                                    </Border>
                                </Grid>
                                <Border Grid.Row="2" Background="{StaticResource Brush.Surface}" CornerRadius="8" Padding="12" BorderBrush="{StaticResource Brush.Border}" BorderThickness="1">
                                    <DataGrid ItemsSource="{Binding Results}" AutoGenerateColumns="False" FontWeight="Bold" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" ScrollViewer.VerticalScrollBarVisibility="Auto" ScrollViewer.HorizontalScrollBarVisibility="Auto" Margin="0">
                                        <DataGrid.Columns>
                                            <DataGridTextColumn Header="Year" Binding="{Binding Year}"/>
                                            <DataGridTextColumn Header="Growth Rate (%)" Binding="{Binding GrowthRate, Mode=TwoWay, StringFormat={}{0:N2}}">
                                                <DataGridTextColumn.ElementStyle>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="ToolTip" Value="Growth Rate = (Current Demand - Previous Demand) / Previous Demand"/>
                                                    </Style>
                                                </DataGridTextColumn.ElementStyle>
                                            </DataGridTextColumn>
                                            <DataGridTextColumn Header="Demand (gallons/day)" Binding="{Binding Demand, StringFormat={}{0:N2}}">
                                                <DataGridTextColumn.ElementStyle>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="ToolTip" Value="Demand = Prior Demand × (1 + Growth Rate)"/>
                                                    </Style>
                                                </DataGridTextColumn.ElementStyle>
                                            </DataGridTextColumn>
                                            <DataGridTextColumn Header="Residential (gallons/day)" Binding="{Binding ResidentialDemand, StringFormat={}{0:N2}}">
                                                <DataGridTextColumn.ElementStyle>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="ToolTip" Value="Residential = Demand × Residential %"/>
                                                    </Style>
                                                </DataGridTextColumn.ElementStyle>
                                            </DataGridTextColumn>
                                            <DataGridTextColumn Header="Commercial (gallons/day)" Binding="{Binding CommercialDemand, StringFormat={}{0:N2}}">
                                                <DataGridTextColumn.ElementStyle>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="ToolTip" Value="Commercial = Demand × Commercial %"/>
                                                    </Style>
                                                </DataGridTextColumn.ElementStyle>
                                            </DataGridTextColumn>
                                            <DataGridTextColumn Header="Industrial (gallons/day)" Binding="{Binding IndustrialDemand, StringFormat={}{0:N2}}">
                                                <DataGridTextColumn.ElementStyle>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="ToolTip" Value="Industrial = Demand × Industrial %"/>
                                                    </Style>
                                                </DataGridTextColumn.ElementStyle>
                                            </DataGridTextColumn>
                                            <DataGridTextColumn Header="Agricultural (gallons/day)" Binding="{Binding AgriculturalDemand, StringFormat={}{0:N2}}">
                                                <DataGridTextColumn.ElementStyle>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="ToolTip" Value="Agricultural = Demand × Agricultural %"/>
                                                    </Style>
                                                </DataGridTextColumn.ElementStyle>
                                            </DataGridTextColumn>
                                            <DataGridTextColumn Header="Adjusted (gallons/day)" Binding="{Binding AdjustedDemand, StringFormat={}{0:N2}}">
                                                <DataGridTextColumn.ElementStyle>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="ToolTip" Value="Adjusted = Demand ÷ (1 - Losses %) × (1 - Improvements %)"/>
                                                    </Style>
                                                </DataGridTextColumn.ElementStyle>
                                            </DataGridTextColumn>
                                            <DataGridTextColumn Header="Adjusted (ac-ft/yr)" Binding="{Binding AdjustedDemandAcreFeet, StringFormat={}{0:N2}}">
                                                <DataGridTextColumn.ElementStyle>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="ToolTip" Value="Adjusted Acre-Feet = Adjusted Demand × 365 ÷ 325,851"/>
                                                    </Style>
                                                </DataGridTextColumn.ElementStyle>
                                            </DataGridTextColumn>
                                        </DataGrid.Columns>
                                    </DataGrid>
                                </Border>
                            </Grid>
                            <Border Grid.Row="1"
                                    Background="{StaticResource Brush.Surface}"
                                    CornerRadius="8"
                                    Padding="16"
                                    BorderBrush="{StaticResource Brush.Border}"
                                    BorderThickness="1"
                                    Margin="0,10,0,0">
                                <StackPanel>
                                    <TextBox Text="{Binding DataContext.ChartTitle, ElementName=Root, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             FontSize="16"
                                             FontWeight="SemiBold"
                                             HorizontalAlignment="Center"
                                             Margin="0,0,0,8"
                                             BorderThickness="0"
                                             Background="Transparent"
                                             TextAlignment="Center"
                                             HorizontalContentAlignment="Center"/>
                                    <TextBlock Text="Line chart plotting adjusted demand by scenario. Years sit on the X-axis and adjusted gallons per day on the Y-axis for each forecast line."
                                               TextWrapping="Wrap"
                                               Foreground="{StaticResource Brush.TextSecondary}"
                                               Margin="0,0,0,12"/>
                                    <ItemsControl ItemsSource="{Binding DataContext.LegendItems, ElementName=Root}"
                                                  Margin="0,0,0,12">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal" Margin="0,0,12,4">
                                                    <Ellipse Width="12"
                                                             Height="12"
                                                             Fill="{Binding Color}"
                                                             Stroke="{StaticResource Brush.Border}"
                                                             StrokeThickness="0.5"
                                                             Margin="0,0,6,0"/>
                                                    <TextBlock Text="{Binding Name}"
                                                               VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                    <Border Background="{StaticResource Brush.ChartFill}"
                                            BorderBrush="{StaticResource Brush.Border}"
                                            BorderThickness="1"
                                            CornerRadius="8"
                                            Padding="8">
                                        <controls:LineGraphControl Height="360"
                                                                   MinHeight="280"
                                                                   Series="{Binding DataContext.ChartSeries, ElementName=Root}"
                                                                   EmptyMessage="{Binding DataContext.ChartStatusMessage, ElementName=Root}"
                                                                   XAxisLabelPrefix="Year "
                                                                   XAxisLabelFormat="N0"
                                                                   YAxisLabelFormat="N0"/>
                                    </Border>
                                </StackPanel>
                            </Border>
                        </Grid>
                    </DataTemplate>
                </TabControl.ContentTemplate>
            </TabControl>
            <Border Grid.Row="2" Style="{StaticResource Border.ResultInfo}" Margin="0,12,0,0">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="" FontSize="18" Foreground="{StaticResource Brush.Primary}" Margin="0,0,8,0"/>
                        <TextBlock Text="Scenario Summary" FontWeight="Bold" Foreground="{StaticResource Brush.Primary}"/>
                    </StackPanel>
                    <TextBlock Text="{Binding SelectedScenario.Description}" TextWrapping="Wrap" Margin="0,6,0,0"/>
                </StackPanel>
            </Border>
            <Border Grid.Row="3" Style="{StaticResource Border.ResultInfo}" Margin="0,12,0,0">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="" FontSize="18" Foreground="{StaticResource Brush.Primary}" Margin="0,0,8,0"/>
                        <TextBlock Text="Forecast Logic" FontWeight="Bold" Foreground="{StaticResource Brush.Primary}"/>
                    </StackPanel>
                    <TextBlock Text="{Binding Explanation}" TextWrapping="Wrap" Margin="0,6,0,0"/>
                </StackPanel>
            </Border>
            <Border Grid.Row="4" Style="{StaticResource Border.ResultInfo}" Margin="0,12,0,0">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="" FontSize="18" Foreground="{StaticResource Brush.Primary}" Margin="0,0,8,0"/>
                        <TextBlock Text="Result guidance" FontWeight="Bold" Foreground="{StaticResource Brush.Primary}"/>
                    </StackPanel>
                    <TextBlock TextWrapping="Wrap" Margin="0,6,0,0">
                        • Growth Rate reflects the year-over-year percent change driven by your population and per-capita assumptions. Higher growth inputs raise this column.
                        <LineBreak/>
                        • Demand shows projected system demand before sector allocations. Each sector column (Residential, Commercial, Industrial, Agricultural) applies the percentages you supplied.
                        <LineBreak/>
                        • Adjusted demand applies the Advanced Adjustments so you can see conservation impacts immediately.
                        <LineBreak/>
                        • Adjusted (ac-ft/yr) multiplies the adjusted demand by 365 and divides by 325,851 so you can translate daily demand into reservoir storage requirements.
                    </TextBlock>
                </StackPanel>
            </Border>
            <Border Grid.Row="5" Style="{StaticResource Border.ResultInfo}" Margin="0,12,0,0">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="" FontSize="18" Foreground="{StaticResource Brush.Primary}" Margin="0,0,8,0"/>
                        <TextBlock Text="Workflow tips" FontWeight="Bold" Foreground="{StaticResource Brush.Primary}"/>
                    </StackPanel>
                    <TextBlock TextWrapping="Wrap" Margin="0,6,0,0">
                        <Run Text="• Review sector percentages after adjusting growth to ensure they still sum to 100%."/>
                        <LineBreak/>
                        <Run Text="• Use Advanced Adjustments to visualize conservation or losses without changing historical baselines."/>
                        <LineBreak/>
                        <Run Text="• Compare scenarios side-by-side in the chart to confirm the selected inputs behave as expected."/>
                    </TextBlock>
                </StackPanel>
            </Border>
            <Border Grid.Row="6" Style="{StaticResource Border.ResultInfo}" Margin="0,12,0,0">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="" FontSize="18" Foreground="{StaticResource Brush.Primary}" Margin="0,0,8,0"/>
                        <TextBlock Text="Formula Reference" FontWeight="Bold" Foreground="{StaticResource Brush.Primary}"/>
                    </StackPanel>
                    <TextBlock TextWrapping="Wrap" Margin="0,6,0,0">
                        <Run Text="• Linear regression fits Demand = m × Year + b, with m = (nΣXY − ΣXΣY)/(nΣX² − (ΣX)²) and b = (ΣY − mΣX)/n."/>
                        <LineBreak/>
                        <Run Text="• Growth rate forecasts use r = (Last/First)^(1/ΔYears) − 1 (or your override), then Demandᵗ = Demandᵗ₋₁ × (1 + r)."/>
                        <LineBreak/>
                        <Run Text="• Scenario demand scales by population and per-capita adjustments; sector shares and advanced adjustments are applied multiplicatively to the projected totals."/>
                    </TextBlock>
                </StackPanel>
            </Border>
        </Grid>
    </ScrollViewer>
</UserControl>
