<UserControl x:Class="EconToolbox.Desktop.Views.GanttView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:EconToolbox.Desktop.Converters"
             Background="{DynamicResource App.SurfaceAlt}"
             SnapsToDevicePixels="True"
             UseLayoutRounding="True">
    <UserControl.Resources>
        <converters:GanttLinkGeometryConverter x:Key="GanttLinkGeometryConverter"
                                               DayScale="18"/>
    </UserControl.Resources>
    <ScrollViewer Style="{StaticResource ScrollViewer.Page}">
        <Grid Style="{StaticResource Layout.ContentGrid}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <Border Grid.Row="0"
                    Style="{StaticResource Border.Explainer}">
                <StackPanel>
                    <Grid VerticalAlignment="Center">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text=""
                                   Style="{StaticResource Text.Icon.Section}"/>
                        <TextBlock Grid.Column="1"
                                   Text="Standard Gantt Planner"
                                   Style="{StaticResource Text.SectionTitleAccent}"
                                   TextWrapping="Wrap"/>
                    </Grid>
                    <TextBlock TextWrapping="Wrap"
                               Style="{StaticResource Text.Body}"
                               Margin="{StaticResource Margin.TopLarge}">
                        Document project tasks, durations, and dependencies. Use the Calculate button at the bottom of the window to refresh the schedule and bars. Export shares the task table and timeline with the rest of the workbook.
                    </TextBlock>
                </StackPanel>
            </Border>
            <Grid Grid.Row="1"
                  Margin="0,12,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Border Style="{StaticResource Border.Card}">
                    <StackPanel>
                        <TextBlock Text="Work Breakdown"
                                   Style="{StaticResource Text.SectionTitle}"
                                   Margin="{StaticResource Margin.StackLarge}"/>
                        <DataGrid CanUserResizeColumns="True" ItemsSource="{Binding Tasks}"
                                  SelectedItem="{Binding SelectedTask, Mode=TwoWay}"
                                  AutoGenerateColumns="False"
                                  CanUserAddRows="True"
                                  HeadersVisibility="Column"
                                  ColumnWidth="SizeToHeader"
                                  Margin="0,0,0,8">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Task" Binding="{Binding Name, Mode=TwoWay}" Width="SizeToHeader">
                                        <DataGridTextColumn.HeaderStyle>
                                            <Style TargetType="DataGridColumnHeader">
                                                <Setter Property="ToolTip" Value="Name of the activity displayed on the schedule. This label appears in the Gantt chart and summary outputs."/>
                                            </Style>
                                        </DataGridTextColumn.HeaderStyle>
                                    </DataGridTextColumn>
                                    <DataGridTemplateColumn Header="Color" Width="SizeToHeader" IsReadOnly="True">
                                        <DataGridTemplateColumn.HeaderStyle>
                                            <Style TargetType="DataGridColumnHeader">
                                                <Setter Property="ToolTip" Value="Color applied to the bar representing this task. The color affects chart readability but not calculations."/>
                                            </Style>
                                        </DataGridTemplateColumn.HeaderStyle>
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Border Background="{Binding ColorBrush}"
                                                        BorderBrush="{Binding BorderBrush}"
                                                        BorderThickness="1"
                                                        CornerRadius="4"
                                                        Height="18"
                                                        Width="36"
                                                        HorizontalAlignment="Center"
                                                        ToolTip="Preview of the color that will be used on the timeline. This preview does not affect calculations."/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTextColumn Header="Workstream" Binding="{Binding Workstream, Mode=TwoWay}" Width="SizeToHeader">
                                        <DataGridTextColumn.HeaderStyle>
                                            <Style TargetType="DataGridColumnHeader">
                                                <Setter Property="ToolTip" Value="Team or workstream responsible for the task. This label is informational and does not change schedule calculations."/>
                                            </Style>
                                        </DataGridTextColumn.HeaderStyle>
                                    </DataGridTextColumn>
                                    <DataGridTemplateColumn Header="Start" Width="SizeToHeader">
                                        <DataGridTemplateColumn.HeaderStyle>
                                            <Style TargetType="DataGridColumnHeader">
                                                <Setter Property="ToolTip" Value="Planned start date for the task. The start date determines the task position and schedule duration."/>
                                            </Style>
                                        </DataGridTemplateColumn.HeaderStyle>
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <DatePicker SelectedDate="{Binding StartDate, Mode=TwoWay}"
                                                            ToolTip="Choose the planned start date for this task. The start date sets where the task begins on the timeline."/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTextColumn Header="Duration (days)" Binding="{Binding DurationDays, Mode=TwoWay}" Width="SizeToHeader">
                                        <DataGridTextColumn.HeaderStyle>
                                            <Style TargetType="DataGridColumnHeader">
                                                <Setter Property="ToolTip" Value="Planned length of the task in calendar days. Duration determines task end date and total labor cost."/>
                                            </Style>
                                        </DataGridTextColumn.HeaderStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="Labor Cost $/day" Width="SizeToHeader">
                                        <DataGridTextColumn.HeaderStyle>
                                            <Style TargetType="DataGridColumnHeader">
                                                <Setter Property="ToolTip" Value="Daily labor rate applied to the task. This rate multiplies by duration to compute task cost."/>
                                            </Style>
                                        </DataGridTextColumn.HeaderStyle>
                                        <DataGridTextColumn.Binding>
                                            <Binding Path="LaborCostPerDay"
                                                     Mode="TwoWay"
                                                     Converter="{StaticResource CurrencyConverter}"/>
                                        </DataGridTextColumn.Binding>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="Task Cost $" Width="SizeToHeader" IsReadOnly="True">
                                        <DataGridTextColumn.HeaderStyle>
                                            <Style TargetType="DataGridColumnHeader">
                                                <Setter Property="ToolTip" Value="Calculated total labor cost (labor rate × duration). This value contributes to the total schedule cost."/>
                                            </Style>
                                        </DataGridTextColumn.HeaderStyle>
                                        <DataGridTextColumn.Binding>
                                            <Binding Path="TotalCost"
                                                     Mode="OneWay"
                                                     Converter="{StaticResource CurrencyConverter}"/>
                                        </DataGridTextColumn.Binding>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="Dependencies" Binding="{Binding Dependencies, Mode=TwoWay}" Width="SizeToHeader">
                                        <DataGridTextColumn.HeaderStyle>
                                            <Style TargetType="DataGridColumnHeader">
                                                <Setter Property="ToolTip" Value="Comma-separated predecessors that must finish before this task starts. Dependencies influence start constraints and schedule logic."/>
                                            </Style>
                                        </DataGridTextColumn.HeaderStyle>
                                    </DataGridTextColumn>
                                    <DataGridCheckBoxColumn Header="Milestone" Binding="{Binding IsMilestone, Mode=TwoWay}" Width="SizeToHeader">
                                        <DataGridCheckBoxColumn.HeaderStyle>
                                            <Style TargetType="DataGridColumnHeader">
                                                <Setter Property="ToolTip" Value="Toggle to flag zero-duration milestones. Milestones are shown as points and do not add duration."/>
                                            </Style>
                                        </DataGridCheckBoxColumn.HeaderStyle>
                                        <DataGridCheckBoxColumn.ElementStyle>
                                            <Style TargetType="CheckBox">
                                                <Setter Property="HorizontalAlignment" Value="Center"/>
                                                <Setter Property="ToolTip" Value="Check to show this task as a milestone on the chart. Milestones do not contribute labor cost."/>
                                            </Style>
                                        </DataGridCheckBoxColumn.ElementStyle>
                                    </DataGridCheckBoxColumn>
                                    <DataGridTextColumn Header="% Complete" Binding="{Binding PercentComplete, Mode=TwoWay}" Width="SizeToHeader">
                                        <DataGridTextColumn.HeaderStyle>
                                            <Style TargetType="DataGridColumnHeader">
                                                <Setter Property="ToolTip" Value="Overall percent complete for this task. This informs progress tracking but does not change schedule dates."/>
                                            </Style>
                                        </DataGridTextColumn.HeaderStyle>
                                    </DataGridTextColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                            <Button Command="{Binding AddTaskCommand}" Style="{StaticResource Button.Action}" Margin="0,0,8,0" ToolTip="Insert a new task row at the bottom of the table. New tasks add duration and cost to the schedule.">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <TextBlock Text="" Style="{StaticResource Text.Icon.Action}"/>
                                    <TextBlock Text="Add Task"/>
                                </StackPanel>
                            </Button>
                            <Button Command="{Binding RemoveTaskCommand}" Style="{StaticResource Button.Action}" Margin="0,0,8,0" ToolTip="Delete the currently selected task from the list. Removing tasks reduces total schedule cost and duration.">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <TextBlock Text="" Style="{StaticResource Text.Icon.Action}"/>
                                    <TextBlock Text="Remove Selected"/>
                                </StackPanel>
                            </Button>
                            <Button Command="{Binding ClearTasksCommand}" Style="{StaticResource Button.Action}" ToolTip="Clear all tasks so you can start a fresh schedule. Clearing resets all schedule and cost calculations.">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <TextBlock Text="" Style="{StaticResource Text.Icon.Action}"/>
                                    <TextBlock Text="Clear"/>
                                </StackPanel>
                            </Button>
                            <TextBlock Text="{Binding TotalLaborCost, StringFormat=Total Cost: {0:C2}}"
                                       Margin="16,0,0,0"
                                       VerticalAlignment="Center"
                                       Style="{StaticResource Text.BodyStrong}"
                                       Foreground="{DynamicResource App.Accent}"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
                <Border Grid.Row="1"
                        Style="{StaticResource Border.Card}"
                        Margin="0,16,0,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="0,0,0,12" VerticalAlignment="Center">
                            <TextBlock Text="" Style="{StaticResource Text.Icon.Section}"/>
                            <StackPanel>
                                <TextBlock Text="Schedule Timeline" Style="{StaticResource Text.SectionHeader}"/>
                                <TextBlock Text="{Binding ScheduleSummary}" Style="{StaticResource Text.BodySmall}"/>
                                <TextBlock Text="Connectors show finish-to-start relationships between tasks."
                                           Style="{StaticResource Text.BodySmall}"
                                           TextWrapping="Wrap"/>
                            </StackPanel>
                        </StackPanel>
                        <Border Grid.Row="1"
                                Style="{StaticResource Border.Panel}"
                                Background="{DynamicResource App.HighlightBackground}"
                                BorderBrush="{DynamicResource App.HighlightBorder}"
                                BorderThickness="1"
                                CornerRadius="8"
                                Padding="8">
                            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                                <Canvas Height="{Binding Bars.Count, Converter={StaticResource RowToPixelConverter}}"
                                        Width="{Binding TotalDurationDays, Converter={StaticResource DayToPixelConverter}}"
                                        MinHeight="220"
                                        MinWidth="560">
                                    <ItemsControl ItemsSource="{Binding Links}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <Canvas />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemContainerStyle>
                                            <Style TargetType="ContentPresenter">
                                                <Setter Property="Canvas.Left" Value="0"/>
                                                <Setter Property="Canvas.Top" Value="0"/>
                                            </Style>
                                        </ItemsControl.ItemContainerStyle>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Path Stroke="{Binding Stroke}"
                                                      StrokeThickness="1.6"
                                                      StrokeStartLineCap="Round"
                                                      StrokeEndLineCap="Round"
                                                      Fill="Transparent"
                                                      Opacity="0.82">
                                                    <Path.Effect>
                                                        <DropShadowEffect Color="{DynamicResource App.Shadow.Color}"
                                                                          BlurRadius="8"
                                                                          ShadowDepth="2"
                                                                          Opacity="0.45"/>
                                                    </Path.Effect>
                                                    <Path.ToolTip>
                                                        <ToolTip Padding="8">
                                                            <StackPanel MaxWidth="260">
                                                                <TextBlock Text="{Binding Caption}" FontWeight="SemiBold" TextWrapping="Wrap"/>
                                                                <TextBlock Text="Dependency links visualize schedule logic; task dates and durations determine link placement."
                                                                           Margin="0,6,0,0"
                                                                           FontSize="11"
                                                                           TextWrapping="Wrap"/>
                                                            </StackPanel>
                                                        </ToolTip>
                                                    </Path.ToolTip>
                                                    <Path.Data>
                                                        <MultiBinding Converter="{StaticResource GanttLinkGeometryConverter}">
                                                            <Binding Path="FromDay"/>
                                                            <Binding Path="ToDay"/>
                                                            <Binding Path="From.CenterLineY"/>
                                                            <Binding Path="To.CenterLineY"/>
                                                        </MultiBinding>
                                                    </Path.Data>
                                                </Path>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                    <ItemsControl ItemsSource="{Binding Bars}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <Canvas />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemContainerStyle>
                                            <Style TargetType="ContentPresenter">
                                                <Setter Property="Canvas.Left" Value="{Binding CanvasOffsetDays, Converter={StaticResource DayToPixelConverter}}"/>
                                                <Setter Property="Canvas.Top" Value="{Binding RowIndex, Converter={StaticResource RowToPixelConverter}}"/>
                                            </Style>
                                        </ItemsControl.ItemContainerStyle>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Grid>
                                                    <Grid.ToolTip>
                                                        <ToolTip Placement="Mouse" Padding="8">
                                                            <StackPanel MaxWidth="260">
                                                                <TextBlock Text="{Binding Task.Name}" FontWeight="SemiBold" TextWrapping="Wrap"/>
                                                                <TextBlock Text="{Binding Task.StartDate, StringFormat=Start: {0:d}}"
                                                                           Margin="0,6,0,0"
                                                                           FontSize="11"/>
                                                                <TextBlock Text="{Binding Task.EndDate, StringFormat=Finish: {0:d}}"
                                                                           FontSize="11"/>
                                                                <TextBlock Text="Start and finish dates come from the task start date plus duration, which set bar placement."
                                                                           Margin="0,6,0,0"
                                                                           FontSize="11"
                                                                           TextWrapping="Wrap"/>
                                                            </StackPanel>
                                                        </ToolTip>
                                                    </Grid.ToolTip>
                                                    <Rectangle Height="28"
                                                               Width="{Binding CanvasDurationDays, Converter={StaticResource DayToPixelConverter}}"
                                                               RadiusX="4"
                                                               RadiusY="4"
                                                               Fill="{Binding Task.ColorBrush}"
                                                               Opacity="{Binding Task.PercentComplete, Converter={StaticResource PercentToOpacityConverter}}"
                                                               Stroke="{Binding Task.BorderBrush}"
                                                               StrokeThickness="1.2">
                                                        <Rectangle.Style>
                                                            <Style TargetType="Rectangle">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsMilestone}" Value="True">
                                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Rectangle.Style>
                                                    </Rectangle>
                                                    <Polygon Points="0,14 12,0 24,14 12,28"
                                                             Fill="{Binding Task.ColorBrush}"
                                                             Stroke="{Binding Task.BorderBrush}"
                                                             StrokeThickness="1.2">
                                                        <Polygon.Style>
                                                            <Style TargetType="Polygon">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsMilestone}" Value="True">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Polygon.Style>
                                                    </Polygon>
                                                </Grid>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Canvas>
                            </ScrollViewer>
                        </Border>
                    </Grid>
                </Border>
            </Grid>
            <StackPanel Grid.Row="2" Margin="0,16,0,0">
                <Border Style="{StaticResource Border.ResultInfo}">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <TextBlock Text="" Style="{StaticResource Text.Icon.Section}"/>
                            <TextBlock Text="Result guidance" Style="{StaticResource Text.SectionHeaderAccent}"/>
                        </StackPanel>
                        <TextBlock TextWrapping="Wrap"
                                   Style="{StaticResource Text.Body}"
                                   Margin="{StaticResource Margin.TopLarge}">
                            The task grid drives the bars, milestone diamonds, and total cost at the bottom of the table. Use the Schedule Summary caption above the chart to describe the active window, and remember that zero-duration tasks render as milestones with the diamond marker.
                        </TextBlock>
                    </StackPanel>
                </Border>
            </StackPanel>
        </Grid>
    </ScrollViewer>
</UserControl>
