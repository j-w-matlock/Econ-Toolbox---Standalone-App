<UserControl x:Class="EconToolbox.Desktop.Views.UpdatedCostView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             Background="{DynamicResource App.SurfaceAlt}"
             SnapsToDevicePixels="True"
             UseLayoutRounding="True">
    <ScrollViewer Style="{StaticResource ScrollViewer.Page}">
        <StackPanel>
            <Border Style="{StaticResource Border.Explainer}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <StackPanel Orientation="Horizontal" Grid.Column="0" VerticalAlignment="Top">
                        <Viewbox Width="32" Height="32" Margin="0,0,10,0">
                            <Canvas Width="32" Height="32">
                                <Rectangle Width="24"
                                           Height="16"
                                           RadiusX="2"
                                           RadiusY="2"
                                           Fill="{DynamicResource App.Accent}"
                                           Canvas.Left="4"
                                           Canvas.Top="8"/>
                                <Rectangle Width="4" Height="12" Fill="{DynamicResource App.Surface}" Opacity="0.6" Canvas.Left="6" Canvas.Top="10"/>
                                <Rectangle Width="4" Height="12" Fill="{DynamicResource App.Surface}" Opacity="0.6" Canvas.Left="14" Canvas.Top="10"/>
                                <Rectangle Width="4" Height="12" Fill="{DynamicResource App.Surface}" Opacity="0.6" Canvas.Left="22" Canvas.Top="10"/>
                                <Path Data="M4,24 C7,22 9,22 12,24 C15,26 17,26 20,24 C23,22 25,22 28,24"
                                      Stroke="{DynamicResource App.AccentHover}"
                                      StrokeThickness="2"
                                      StrokeStartLineCap="Round"
                                      StrokeEndLineCap="Round"
                                      Fill="Transparent"/>
                            </Canvas>
                        </Viewbox>
                    </StackPanel>
                    <StackPanel Grid.Column="1">
                        <StackPanel.Style>
                            <Style TargetType="StackPanel">
                                <Setter Property="Grid.Row" Value="0"/>
                                <Setter Property="Grid.ColumnSpan" Value="1"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=Border}, Converter={StaticResource WidthToLayoutModeConverter}}"
                                                 Value="Narrow">
                                        <Setter Property="Grid.ColumnSpan" Value="2"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </StackPanel.Style>
                        <TextBlock Text="Updated Cost Workflow"
                                   FontSize="16"
                                   FontWeight="Bold"
                                   Foreground="{DynamicResource App.Accent}"
                                   TextWrapping="Wrap"/>
                        <TextBlock Style="{StaticResource Text.Body}" Margin="0,6,0,0">
                            <Run Text="• Work through each sub-tab from left to right so dependent calculations stay aligned."/>
                            <LineBreak/>
                            <Run Text="• Start with storage capacity, capture annual joint costs, then update historical line items."/>
                            <LineBreak/>
                            <Run Text="• Evaluate RR&amp;R, mitigation, and total annual cost scenarios once upstream inputs are finalized."/>
                            <LineBreak/>
                            <Run Text="• Press Compute within each section before leaving the tab to keep downstream values synchronized."/>
                        </TextBlock>
                    </StackPanel>
                    <Canvas Width="80" Height="60">
                        <Canvas.Style>
                            <Style TargetType="Canvas">
                                <Setter Property="Grid.Column" Value="2"/>
                                <Setter Property="Grid.Row" Value="0"/>
                                <Setter Property="Margin" Value="15,0,0,0"/>
                                <Setter Property="HorizontalAlignment" Value="Right"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=Border}, Converter={StaticResource WidthToLayoutModeConverter}}"
                                                 Value="Narrow">
                                        <Setter Property="Grid.Column" Value="0"/>
                                        <Setter Property="Grid.Row" Value="1"/>
                                        <Setter Property="Margin" Value="0,12,0,0"/>
                                        <Setter Property="HorizontalAlignment" Value="Center"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Canvas.Style>
                        <Rectangle Width="70" Height="40" Fill="{DynamicResource App.Surface}" Stroke="{DynamicResource App.AccentHover}" RadiusX="6" RadiusY="6" Canvas.Left="5" Canvas.Top="15"/>
                        <Polyline Points="5,45 25,25 45,30 65,10" Stroke="{DynamicResource App.Accent}" StrokeThickness="3" StrokeEndLineCap="Round" StrokeStartLineCap="Round"/>
                        <Ellipse Width="8" Height="8" Fill="{DynamicResource App.AccentHover}" Canvas.Left="1" Canvas.Top="41"/>
                        <Ellipse Width="8" Height="8" Fill="{DynamicResource App.AccentHover}" Canvas.Left="21" Canvas.Top="21"/>
                        <Ellipse Width="8" Height="8" Fill="{DynamicResource App.AccentHover}" Canvas.Left="41" Canvas.Top="26"/>
                        <Ellipse Width="8" Height="8" Fill="{DynamicResource App.AccentHover}" Canvas.Left="61" Canvas.Top="6"/>
                    </Canvas>
                </Grid>
            </Border>
            <TabControl Margin="0" HorizontalContentAlignment="Stretch">
                <TabItem Header="Storage Cost">
                    <StackPanel Margin="0">
                        <Border Style="{StaticResource Border.Explainer}" Margin="0,0,0,12">
                            <StackPanel>
                                <Grid VerticalAlignment="Center">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock FontFamily="Segoe MDL2 Assets"
                                               Text=""
                                               FontSize="18"
                                               Foreground="{DynamicResource App.Accent}"
                                               Margin="0,0,8,0"/>
                                    <TextBlock Grid.Column="1"
                                               Text="Storage Guidance"
                                               FontWeight="Bold"
                                               Foreground="{DynamicResource App.Accent}"
                                               TextWrapping="Wrap"/>
                                </Grid>
                                <TextBlock Style="{StaticResource Text.Body}" Margin="0,6,0,0">
                                    <Run Text="• Record the full system storage and the recommended allocation for your study."/>
                                    <LineBreak/>
                                    <Run Text="• Use Compute to scale the remaining sections by this proportion before moving forward."/>
                                </TextBlock>
                            </StackPanel>
                        </Border>
                        <Grid Margin="0,10,0,10">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                    <TextBlock Margin="0,0,5,5" Text="Total Usable Storage"/>
                    <TextBox Text="{Binding TotalStorage}"
                             Grid.Column="1"
                             Width="240"
                             HorizontalAlignment="Left"
                             Margin="0,0,0,5"
                             ToolTip="Enter the system's total usable storage before any plan allocation. This value is the denominator for the storage percentage used to scale costs."/>
                    <TextBlock Grid.Row="1" Margin="0,0,5,5" Text="Storage Recommendation"/>
                    <TextBox Text="{Binding StorageRecommendation}"
                             Grid.Row="1"
                             Grid.Column="1"
                             Width="240"
                             HorizontalAlignment="Left"
                             Margin="0,0,0,5"
                             ToolTip="Recommended portion of the joint storage allocated to this alternative. This value is the numerator used to scale downstream costs."/>
                    <Button Command="{Binding ComputeStorageCommand}"
                            Grid.Row="2"
                            Grid.ColumnSpan="2"
                            Margin="0,5,0,5"
                            ToolTip="Calculate the storage utilization percentage based on the values above. The resulting percent drives cost allocations across the other tabs.">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <TextBlock FontFamily="Segoe MDL2 Assets"
                                       Text="&#xE8EF;"
                                       FontSize="18"
                                       Margin="0,0,6,0"/>
                            <TextBlock Text="Compute"/>
                        </StackPanel>
                    </Button>
                    <TextBlock Text="{Binding Percent, Mode=OneWay, StringFormat=P: {0:F5}}" Grid.Row="3" Grid.ColumnSpan="2" ToolTip="Percent = Storage Recommendation / Total Usable Storage. This percentage scales joint O&amp;M, RR&amp;R, and capital costs."/>
                </Grid>
                <Border Style="{StaticResource Border.ResultInfo}" Margin="0">
                    <TextBlock TextWrapping="Wrap">
                        The resulting P value shows how much of the joint facilities support your recommendation. Increasing the recommendation or decreasing total storage raises the percentage and, consequently, the share of downstream costs assigned to this project.
                    </TextBlock>
                </Border>
                <Border Style="{StaticResource Border.ResultInfo}" Margin="0,8,0,0">
                    <TextBlock TextWrapping="Wrap">
                        • Storage utilization is computed as Percent = Storage Recommendation ÷ Total Usable Storage. The value is clamped to zero when either input is missing.
                    </TextBlock>
                </Border>
            </StackPanel>
        </TabItem>
        <TabItem Header="Joint Costs O&amp;M">
            <StackPanel Margin="10">
                <Border Style="{StaticResource Border.Explainer}" Margin="0,0,0,12">
                    <StackPanel>
                        <Grid VerticalAlignment="Center">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock FontFamily="Segoe MDL2 Assets"
                                       Text=""
                                       FontSize="18"
                                       Foreground="{DynamicResource App.Accent}"
                                       Margin="0,0,8,0"/>
                            <TextBlock Grid.Column="1"
                                       Text="Joint O&amp;M Entry"
                                       FontWeight="Bold"
                                       Foreground="{DynamicResource App.Accent}"
                                       TextWrapping="Wrap"/>
                        </Grid>
                        <TextBlock Style="{StaticResource Text.Body}" Margin="0,6,0,0">
                            <Run Text="• Enter system-wide joint operating and maintenance costs on an annual basis."/>
                            <LineBreak/>
                            <Run Text="• Use Compute to capture the running total that will later be scaled by the storage percentage."/>
                        </TextBlock>
                    </StackPanel>
                </Border>
                <Grid Margin="0,10,0,10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Margin="0,0,5,5" Text="Joint Operations Cost"/>
                    <TextBox Text="{Binding JointOperationsCost, Converter={StaticResource CurrencyConverter}}"
                             Grid.Column="1"
                             Width="240"
                             HorizontalAlignment="Left"
                             Margin="0,0,0,5"
                             ToolTip="Annual system-wide joint operations expense before scaling. This amount is multiplied by the storage percentage in total cost results."/>
                    <TextBlock Grid.Row="1" Margin="0,0,5,5" Text="Joint Maintenance Cost"/>
                    <TextBox Text="{Binding JointMaintenanceCost, Converter={StaticResource CurrencyConverter}}"
                             Grid.Row="1"
                             Grid.Column="1"
                             Width="240"
                             HorizontalAlignment="Left"
                             Margin="0,0,0,5"
                             ToolTip="Annual joint maintenance expense for the entire system. This amount is multiplied by the storage percentage in total cost results."/>
                    <Button Grid.Row="2" Grid.ColumnSpan="2" Margin="0,5,0,5" Command="{Binding ComputeJointCommand}"
                            ToolTip="Sum annual joint operations and maintenance costs for allocation. The sum feeds the joint O&amp;M scaling in total annual cost.">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <TextBlock FontFamily="Segoe MDL2 Assets"
                                       Text="&#xE8EF;"
                                       FontSize="18"
                                       Margin="0,0,6,0"/>
                            <TextBlock Text="Compute"/>
                        </StackPanel>
                    </Button>
                    <TextBlock Text="{Binding TotalJointOm, Mode=OneWay, StringFormat=Total Joint O&amp;M: {0:C2}}" Grid.Row="3" Grid.ColumnSpan="2" ToolTip="Total Joint O&amp;M = Joint Operations Cost + Joint Maintenance Cost. This total is later scaled by the storage percentage."/>
                </Grid>
                <Border Style="{StaticResource Border.ResultInfo}" Margin="0">
                    <TextBlock TextWrapping="Wrap">
                        This total represents the joint-system expenses before scaling. When the storage percentage increases, more of this amount will be allocated to the recommended plan in the Total Annual Cost tab.
                    </TextBlock>
                </Border>
                <Border Style="{StaticResource Border.ResultInfo}" Margin="0,8,0,0">
                    <TextBlock TextWrapping="Wrap">
                        • Total Joint O&amp;M = Joint Operations Cost + Joint Maintenance Cost. The value is recalculated whenever either input changes.
                    </TextBlock>
                </Border>
            </StackPanel>
        </TabItem>
        <TabItem Header="Updated Storage Cost">
            <StackPanel Margin="10">
                <StackPanel.Resources>
                    <Style TargetType="DataGridCell" x:Key="RequiredCellBaseStyle">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderBrush" Value="{DynamicResource App.Border}"/>
                        <Setter Property="BorderThickness" Value="0,0,0,1"/>
                    </Style>
                    <Style x:Key="NumericCellStyle" TargetType="TextBlock">
                        <Setter Property="TextAlignment" Value="Right"/>
                        <Setter Property="Padding" Value="0,0,4,0"/>
                    </Style>
                    <Style x:Key="NumericEditingStyle" TargetType="TextBox">
                        <Setter Property="HorizontalContentAlignment" Value="Right"/>
                    </Style>
                    <Style x:Key="CategoryCellStyle" TargetType="DataGridCell" BasedOn="{StaticResource RequiredCellBaseStyle}">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Category}" Value="">
                                <Setter Property="Background" Value="{DynamicResource App.WarningBackground}"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Category}" Value="{x:Null}">
                                <Setter Property="Background" Value="{DynamicResource App.WarningBackground}"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                    <Style x:Key="JointUseCellStyle" TargetType="DataGridCell" BasedOn="{StaticResource RequiredCellBaseStyle}">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding JointUsePre1967}" Value="0">
                                <Setter Property="Background" Value="{DynamicResource App.WarningBackground}"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                    <Style x:Key="PreEnrCellStyle" TargetType="DataGridCell" BasedOn="{StaticResource RequiredCellBaseStyle}">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Pre1967EnrIndex}" Value="0">
                                <Setter Property="Background" Value="{DynamicResource App.WarningBackground}"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                    <Style x:Key="TransitionEnrCellStyle" TargetType="DataGridCell" BasedOn="{StaticResource RequiredCellBaseStyle}">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding TransitionEnrIndex}" Value="0">
                                <Setter Property="Background" Value="{DynamicResource App.WarningBackground}"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                    <Style x:Key="Enr1967CellStyle" TargetType="DataGridCell" BasedOn="{StaticResource RequiredCellBaseStyle}">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Enr1967Index}" Value="0">
                                <Setter Property="Background" Value="{DynamicResource App.WarningBackground}"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                    <Style x:Key="CwccisBaseCellStyle" TargetType="DataGridCell" BasedOn="{StaticResource RequiredCellBaseStyle}">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding CwccisBase}" Value="0">
                                <Setter Property="Background" Value="{DynamicResource App.WarningBackground}"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                    <Style x:Key="CwccisIndexCellStyle" TargetType="DataGridCell" BasedOn="{StaticResource RequiredCellBaseStyle}">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding CwccisIndex}" Value="0">
                                <Setter Property="Background" Value="{DynamicResource App.WarningBackground}"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                    <Style x:Key="JointUseTextStyle" TargetType="TextBlock" BasedOn="{StaticResource NumericCellStyle}">
                        <Setter Property="Foreground" Value="{DynamicResource App.Link.JointUse}"/>
                    </Style>
                    <Style x:Key="JointUseEditingTextStyle" TargetType="TextBox" BasedOn="{StaticResource NumericEditingStyle}">
                        <Setter Property="Foreground" Value="{DynamicResource App.Link.JointUse}"/>
                    </Style>
                    <Style x:Key="PreEnrTextStyle" TargetType="TextBlock" BasedOn="{StaticResource NumericCellStyle}">
                        <Setter Property="Foreground" Value="{DynamicResource App.Link.PreEnr}"/>
                    </Style>
                    <Style x:Key="PreEnrEditingTextStyle" TargetType="TextBox" BasedOn="{StaticResource NumericEditingStyle}">
                        <Setter Property="Foreground" Value="{DynamicResource App.Link.PreEnr}"/>
                    </Style>
                    <Style x:Key="TransitionEnrTextStyle" TargetType="TextBlock" BasedOn="{StaticResource NumericCellStyle}">
                        <Setter Property="Foreground" Value="{DynamicResource App.Link.TransitionEnr}"/>
                    </Style>
                    <Style x:Key="TransitionEnrEditingTextStyle" TargetType="TextBox" BasedOn="{StaticResource NumericEditingStyle}">
                        <Setter Property="Foreground" Value="{DynamicResource App.Link.TransitionEnr}"/>
                    </Style>
                    <Style x:Key="Enr1967TextStyle" TargetType="TextBlock" BasedOn="{StaticResource NumericCellStyle}">
                        <Setter Property="Foreground" Value="{DynamicResource App.Link.Enr1967}"/>
                    </Style>
                    <Style x:Key="Enr1967EditingTextStyle" TargetType="TextBox" BasedOn="{StaticResource NumericEditingStyle}">
                        <Setter Property="Foreground" Value="{DynamicResource App.Link.Enr1967}"/>
                    </Style>
                    <Style x:Key="CwccisBaseTextStyle" TargetType="TextBlock" BasedOn="{StaticResource NumericCellStyle}">
                        <Setter Property="Foreground" Value="{DynamicResource App.Link.CwccisBase}"/>
                    </Style>
                    <Style x:Key="CwccisBaseEditingTextStyle" TargetType="TextBox" BasedOn="{StaticResource NumericEditingStyle}">
                        <Setter Property="Foreground" Value="{DynamicResource App.Link.CwccisBase}"/>
                    </Style>
                    <Style x:Key="CwccisIndexTextStyle" TargetType="TextBlock" BasedOn="{StaticResource NumericCellStyle}">
                        <Setter Property="Foreground" Value="{DynamicResource App.Link.CwccisCurrent}"/>
                    </Style>
                    <Style x:Key="CwccisIndexEditingTextStyle" TargetType="TextBox" BasedOn="{StaticResource NumericEditingStyle}">
                        <Setter Property="Foreground" Value="{DynamicResource App.Link.CwccisCurrent}"/>
                    </Style>
                </StackPanel.Resources>
                <Border Style="{StaticResource Border.Explainer}" Margin="0,0,0,12">
                    <StackPanel>
                        <Grid VerticalAlignment="Center">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock FontFamily="Segoe MDL2 Assets"
                                       Text=""
                                       FontSize="18"
                                       Foreground="{DynamicResource App.Accent}"
                                       Margin="0,0,8,0"/>
                            <TextBlock Grid.Column="1"
                                       Text="Update Legacy Costs"
                                       FontWeight="Bold"
                                       Foreground="{DynamicResource App.Accent}"
                                       TextWrapping="Wrap"/>
                        </Grid>
                        <TextBlock TextWrapping="Wrap" Margin="0,6,0,0">
                            Replace historical construction costs with current values by pairing each category with the proper update factor. Keep the categories clear so the export remains audit friendly.
                        </TextBlock>
                    </StackPanel>
                </Border>
                <Grid Margin="0,8,0,10">
                    <Grid.Resources>
                        <Style TargetType="TextBlock" x:Key="UpdatedCostLabelTextStyle">
                            <Setter Property="FontWeight" Value="SemiBold"/>
                            <Setter Property="Margin" Value="0,0,0,4"/>
                        </Style>
                        <Style TargetType="TextBlock" x:Key="UpdatedCostColumnHeaderTextStyle">
                            <Setter Property="FontWeight" Value="Bold"/>
                            <Setter Property="Foreground" Value="{DynamicResource App.Accent}"/>
                            <Setter Property="Margin" Value="0,0,0,12"/>
                        </Style>
                        <Style TargetType="TextBlock" x:Key="RequiredCategoryTextStyle">
                            <Setter Property="FontWeight" Value="SemiBold"/>
                        </Style>
                    </Grid.Resources>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Margin="0,0,12,0">
                        <TextBlock Text="Pre-Construction Inputs" Style="{StaticResource UpdatedCostColumnHeaderTextStyle}"/>
                        <StackPanel Margin="0,0,0,8">
                            <TextBlock Text="Original ENR Index Year" Style="{StaticResource UpdatedCostLabelTextStyle}"/>
                            <TextBox Text="{Binding PreEnrYear}"
                                     Foreground="{DynamicResource App.Link.PreEnr}"
                                     HorizontalContentAlignment="Right"
                                     ToolTip="Year associated with the initial ENR index values. This year determines the starting ENR index used in escalation ratios."/>
                        </StackPanel>
                        <StackPanel Margin="0,0,0,8">
                            <TextBlock Text="Original ENR Index Value" Style="{StaticResource UpdatedCostLabelTextStyle}"/>
                            <TextBox Text="{Binding PreEnrIndexValue}"
                                     Foreground="{DynamicResource App.Link.PreEnr}"
                                     HorizontalContentAlignment="Right"
                                     ToolTip="ENR index value tied to the original pre-construction year. This value is used to compute ENR escalation ratios."/>
                        </StackPanel>
                    </StackPanel>
                    <StackPanel Grid.Column="1" Margin="0,0,12,0">
                        <TextBlock Text="Transition Inputs" Style="{StaticResource UpdatedCostColumnHeaderTextStyle}"/>
                        <StackPanel Margin="0,0,0,8">
                            <TextBlock Text="Transition ENR Index Year" Style="{StaticResource UpdatedCostLabelTextStyle}"/>
                            <TextBox Text="{Binding TransitionEnrYear}"
                                     Foreground="{DynamicResource App.Link.TransitionEnr}"
                                     HorizontalContentAlignment="Right"
                                     ToolTip="Year associated with the transition ENR index values. This year defines the transition ENR index used in ratio calculations."/>
                        </StackPanel>
                        <StackPanel Margin="0,0,0,8">
                            <TextBlock Text="Transition ENR Index Value" Style="{StaticResource UpdatedCostLabelTextStyle}"/>
                            <TextBox Text="{Binding TransitionEnrIndexValue}"
                                     Foreground="{DynamicResource App.Link.TransitionEnr}"
                                     HorizontalContentAlignment="Right"
                                     ToolTip="ENR index value used for the transition mid-point. This value is used in ENR ratio calculations to update joint-use costs."/>
                        </StackPanel>
                    </StackPanel>
                    <StackPanel Grid.Column="2">
                        <TextBlock Text="Base-Year &amp; CWCCIS Settings" Style="{StaticResource UpdatedCostColumnHeaderTextStyle}"/>
                        <StackPanel Margin="0,0,0,8">
                            <TextBlock Text="1967 ENR Index Year" Style="{StaticResource UpdatedCostLabelTextStyle}"/>
                            <TextBox Text="{Binding Enr1967Year}"
                                     Foreground="{DynamicResource App.Link.Enr1967}"
                                     HorizontalContentAlignment="Right"
                                     ToolTip="Year anchoring the ENR and CWCCIS indexing, typically 1967. This base year is used to normalize escalation factors."/>
                        </StackPanel>
                        <StackPanel Margin="0,0,0,8">
                            <TextBlock Text="1967 ENR Index Value" Style="{StaticResource UpdatedCostLabelTextStyle}"/>
                            <TextBox Text="{Binding Enr1967IndexValue}"
                                     Foreground="{DynamicResource App.Link.Enr1967}"
                                     HorizontalContentAlignment="Right"
                                     ToolTip="ENR index value for the 1967 base year. This value anchors the ENR ratio applied to transition costs."/>
                        </StackPanel>
                        <StackPanel Margin="0,0,0,8">
                            <TextBlock Text="1967 CWCCIS Base Index Value" Style="{StaticResource UpdatedCostLabelTextStyle}"/>
                            <TextBox Text="{Binding CwccisBaseIndexValue}"
                                     Foreground="{DynamicResource App.Link.CwccisBase}"
                                     HorizontalContentAlignment="Right"
                                     ToolTip="CWCCIS base index value for 1967 (commonly 100). This is the denominator for the CWCCIS update factor."/>
                        </StackPanel>
                        <StackPanel>
                            <TextBlock Text="CWCCIS Index Year" Style="{StaticResource UpdatedCostLabelTextStyle}"/>
                            <TextBox Text="{Binding CwccisIndexYear}"
                                     Foreground="{DynamicResource App.Link.CwccisCurrent}"
                                     HorizontalContentAlignment="Right"
                                     ToolTip="Calendar year tied to the current CWCCIS index values. This sets the timing for the CWCCIS update factor applied to costs."/>
                        </StackPanel>
                    </StackPanel>
                </Grid>
                <Border Style="{StaticResource Border.ResultInfo}" Margin="0,0,0,10">
                    <TextBlock TextWrapping="Wrap">
                        Matched colors now show which table columns draw from the inputs above. Highlighted cells mark fields that need values before the update calculation can run.
                    </TextBlock>
                </Border>
                <TextBlock Text="Step 1: Escalate pre-1967 joint-use costs to the 1967 base (index 100)."
                           FontWeight="SemiBold"
                           Margin="0,0,0,6"/>
                <DataGrid CanUserResizeColumns="True" ItemsSource="{Binding UpdatedCostItems}"
                          AutoGenerateColumns="False"
                          Height="202"
                          RowHeight="28"
                          ColumnHeaderHeight="34"
                          Margin="0,0,0,12"
                          ColumnWidth="SizeToHeader">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Category" Binding="{Binding Category}" CellStyle="{StaticResource CategoryCellStyle}">
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="ToolTip" Value="Name or description of the cost item being escalated. Categories help map inputs to updated cost totals and reports."/>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn ElementStyle="{StaticResource JointUseTextStyle}"
                                            EditingElementStyle="{StaticResource JointUseEditingTextStyle}"
                                            CellStyle="{StaticResource JointUseCellStyle}">
                            <DataGridTextColumn.Binding>
                                <Binding Path="JointUsePre1967" Converter="{StaticResource CurrencyConverter}"/>
                            </DataGridTextColumn.Binding>
                            <DataGridTextColumn.Header>
                                <TextBlock Margin="0"
                                           VerticalAlignment="Center"
                                           Foreground="{DynamicResource App.Link.JointUse}"
                                           Text="Original Joint Use Costs at Midpoint of Construction"/>
                            </DataGridTextColumn.Header>
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="ToolTip" Value="Joint-use cost at the mid-point of construction using the original ENR year. This is the base cost that gets escalated through ENR and CWCCIS factors."/>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Binding="{Binding Pre1967EnrIndex}"
                                           ElementStyle="{StaticResource PreEnrTextStyle}"
                                           EditingElementStyle="{StaticResource PreEnrEditingTextStyle}"
                                           CellStyle="{StaticResource PreEnrCellStyle}"
                                           Header="Original Joint Use Costs ENR Index Value">
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="ToolTip" Value="ENR index value associated with the original joint-use cost before transitioning to 1967 base."/>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn IsReadOnly="True" ElementStyle="{StaticResource NumericCellStyle}">
                            <DataGridTextColumn.Binding>
                                <Binding Path="EnrRatioPreToTransition" StringFormat="{}{0:N2}"/>
                            </DataGridTextColumn.Binding>
                            <DataGridTextColumn.Header>
                                <TextBlock Text="ENR Ratio"/>
                            </DataGridTextColumn.Header>
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="ToolTip" Value="Ratio used to escalate the pre-1967 ENR index to the transition index."/>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Binding="{Binding TransitionEnrIndex}"
                                           ElementStyle="{StaticResource TransitionEnrTextStyle}"
                                           EditingElementStyle="{StaticResource TransitionEnrEditingTextStyle}"
                                           CellStyle="{StaticResource TransitionEnrCellStyle}">
                            <DataGridTextColumn.Header>
                                <TextBlock Text="Transition ENR Index Value" Foreground="{DynamicResource App.Link.TransitionEnr}"/>
                            </DataGridTextColumn.Header>
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="ToolTip" Value="ENR index value used for the transition year between pre-1967 and 1967 base."/>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Binding="{Binding Enr1967Index}"
                                           ElementStyle="{StaticResource Enr1967TextStyle}"
                                           EditingElementStyle="{StaticResource Enr1967EditingTextStyle}"
                                           CellStyle="{StaticResource Enr1967CellStyle}">
                            <DataGridTextColumn.Header>
                                <TextBlock Text="1967 ENR Index Value" Foreground="{DynamicResource App.Link.Enr1967}"/>
                            </DataGridTextColumn.Header>
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="ToolTip" Value="ENR index value for the 1967 base used in the escalation chain."/>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn IsReadOnly="True" ElementStyle="{StaticResource NumericCellStyle}">
                            <DataGridTextColumn.Binding>
                                <Binding Path="EnrRatioTransitionTo1967" StringFormat="{}{0:N2}"/>
                            </DataGridTextColumn.Binding>
                            <DataGridTextColumn.Header>
                                <TextBlock Text="ENR Update Ratio"/>
                            </DataGridTextColumn.Header>
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="ToolTip" Value="Ratio used to update the transition ENR index to the 1967 base index."/>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn IsReadOnly="True" ElementStyle="{StaticResource NumericCellStyle}">
                            <DataGridTextColumn.Binding>
                                <Binding Path="JointUse1967" Converter="{StaticResource CurrencyConverter}"/>
                            </DataGridTextColumn.Binding>
                            <DataGridTextColumn.Header>
                                <TextBlock Text="Adjusted Joint Use Costs at 1967 Base"/>
                            </DataGridTextColumn.Header>
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="ToolTip" Value="Joint-use costs escalated to the 1967 base using ENR ratios."/>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>
                <TextBlock Text="Step 2: Apply CWCCIS to updated 1967-base costs."
                           FontWeight="SemiBold"
                           Margin="0,0,0,6"/>
                <DataGrid CanUserResizeColumns="True" ItemsSource="{Binding UpdatedCostItems}"
                          AutoGenerateColumns="False"
                          Height="202"
                          RowHeight="28"
                          ColumnHeaderHeight="34"
                          Margin="0,0,0,5"
                          ColumnWidth="SizeToHeader">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Category" Binding="{Binding Category}" CellStyle="{StaticResource CategoryCellStyle}">
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="ToolTip" Value="Category labels follow each item into the CWCCIS update step."/>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn ElementStyle="{StaticResource JointUseTextStyle}"
                                            EditingElementStyle="{StaticResource JointUseEditingTextStyle}"
                                            CellStyle="{StaticResource JointUseCellStyle}">
                            <DataGridTextColumn.Binding>
                                <Binding Path="JointUse1967" Converter="{StaticResource CurrencyConverter}"/>
                            </DataGridTextColumn.Binding>
                            <DataGridTextColumn.Header>
                                <TextBlock Text="Joint Use Costs at Midpoint of Construction"/>
                            </DataGridTextColumn.Header>
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="ToolTip" Value="Joint-use costs at the midpoint of construction expressed in 1967 base dollars."/>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Binding="{Binding CwccisBase}"
                                           ElementStyle="{StaticResource CwccisBaseTextStyle}"
                                           EditingElementStyle="{StaticResource CwccisBaseEditingTextStyle}"
                                           CellStyle="{StaticResource CwccisBaseCellStyle}">
                            <DataGridTextColumn.Header>
                                <TextBlock Text="CWCCIS Base Index" Foreground="{DynamicResource App.Link.CwccisBase}"/>
                            </DataGridTextColumn.Header>
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="ToolTip" Value="CWCCIS base index used to compute the escalation factor."/>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Binding="{Binding CwccisIndex}"
                                           ElementStyle="{StaticResource CwccisIndexTextStyle}"
                                           EditingElementStyle="{StaticResource CwccisIndexEditingTextStyle}"
                                           CellStyle="{StaticResource CwccisIndexCellStyle}">
                            <DataGridTextColumn.Header>
                                <TextBlock Text="Current CWCCIS Index"
                                           Foreground="{DynamicResource App.Link.CwccisCurrent}"
                                           VerticalAlignment="Center"/>
                            </DataGridTextColumn.Header>
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="ToolTip" Value="Latest CWCCIS index value used for escalation. This drives the CWCCIS update factor applied to 1967 costs."/>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn IsReadOnly="True" ElementStyle="{StaticResource NumericCellStyle}">
                            <DataGridTextColumn.Binding>
                                <Binding Path="CwccisUpdateFactor" StringFormat="{}{0:N2}"/>
                            </DataGridTextColumn.Binding>
                            <DataGridTextColumn.Header>
                                <TextBlock Text="CWCCIS Update Value"/>
                            </DataGridTextColumn.Header>
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="ToolTip" Value="Computed CWCCIS update factor based on the base and current index values."/>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn IsReadOnly="True" ElementStyle="{StaticResource NumericCellStyle}">
                            <DataGridTextColumn.Binding>
                                <Binding Path="UpdatedJointCost" Converter="{StaticResource CurrencyConverter}"/>
                            </DataGridTextColumn.Binding>
                            <DataGridTextColumn.Header>
                                <TextBlock Text="Updated Storage Cost"/>
                            </DataGridTextColumn.Header>
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="ToolTip" Value="Final updated joint-use cost after applying CWCCIS escalation."/>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>
                <Button Margin="0,4,0,4"
                        Command="{Binding ResetUpdatedCostItemsCommand}"
                        HorizontalAlignment="Left"
                        ToolTip="Clear all updated cost rows so you can rebuild the table from scratch. Clearing removes their contribution to total updated cost.">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE72C;" FontSize="16" Margin="0,0,6,0"/>
                        <TextBlock Text="Reset Table"/>
                    </StackPanel>
                </Button>
                <Button Margin="0,5,0,5"
                        Command="{Binding ComputeUpdatedStorageCommand}"
                        ToolTip="Escalate the cost rows using the ENR and CWCCIS factors provided above. This recalculates the updated joint cost totals used in annualized scenarios.">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock FontFamily="Segoe MDL2 Assets"
                                   Text="&#xE8EF;"
                                   FontSize="18"
                                   Margin="0,0,6,0"/>
                        <TextBlock Text="Compute"/>
                    </StackPanel>
                </Button>
                <Border Style="{StaticResource Border.ResultInfo}" Margin="0">
                    <StackPanel>
                        <TextBlock FontWeight="Bold">
                            <Run Text="Total "/>
                            <Run Text="{Binding UpdatedJointCostLabel, Mode=OneWay}"/>
                            <Run Text=": "/>
                            <Run Text="{Binding TotalUpdatedCost, Mode=OneWay, StringFormat={}{0:C2}}"/>
                        </TextBlock>
                        <TextBlock TextWrapping="Wrap" Margin="0,6,0,0">
                            Each line item is escalated from the original ENR year to the 1967 CWCCIS base and then multiplied by the CWCCIS update value. The resulting total carries forward into the capital cost scenarios.
                        </TextBlock>
                    </StackPanel>
                </Border>
                <Border Style="{StaticResource Border.ResultInfo}" Margin="0,8,0,0">
                    <TextBlock TextWrapping="Wrap">
                        • ENR ratio (pre → transition) = Transition ENR Index ÷ Pre ENR Index, and Joint Use Transition = Joint Use Pre-1967 × ENR ratio.
                        <LineBreak/>
                        • ENR ratio (transition → 1967) = 1967 ENR Index ÷ Transition ENR Index, and Joint Use 1967 = Joint Use Transition × ENR ratio.
                        <LineBreak/>
                        • CWCCIS update factor = Current CWCCIS Index ÷ CWCCIS Base; Updated Joint Cost = Joint Use 1967 × CWCCIS update factor.
                        <LineBreak/>
                        • Total Updated Cost is the sum of Updated Joint Cost across all rows.
                    </TextBlock>
                </Border>
            </StackPanel>
        </TabItem>
        <TabItem Header="RR&amp;R and Mitigation">
            <StackPanel Margin="10">
                <Border Style="{StaticResource Border.Explainer}" Margin="0,0,0,12">
                    <StackPanel>
                        <Grid VerticalAlignment="Center">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock FontFamily="Segoe MDL2 Assets"
                                       Text=""
                                       FontSize="18"
                                       Foreground="{DynamicResource App.Accent}"
                                       Margin="0,0,8,0"/>
                            <TextBlock Grid.Column="1"
                                       Text="RR&amp;R / Mitigation Planner"
                                       FontWeight="Bold"
                                       Foreground="{DynamicResource App.Accent}"
                                       TextWrapping="Wrap"/>
                        </Grid>
                        <TextBlock TextWrapping="Wrap" Margin="0,6,0,0">
                            Capture future repair, replacement, rehabilitation, and mitigation costs. Use the grid to list each activity, the year it occurs, and its cost in that year dollars. The tool discounts everything back to the base year for annualization.
                        </TextBlock>
                    </StackPanel>
                </Border>
                <Grid Margin="0,10,0,10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Margin="0,0,5,5" Text="Federal Discount Rate (%)"/>
                    <TextBox Text="{Binding RrrRate}"
                             Grid.Column="1"
                             Width="240"
                             HorizontalAlignment="Left"
                             Margin="0,0,0,5"
                             ToolTip="Real federal discount rate applied to future RR&amp;R and mitigation costs. Higher rates reduce present value and annualized totals."/>
                    <TextBlock Grid.Row="1" Margin="0,0,5,5" Text="Analysis Years"/>
                    <TextBox Text="{Binding RrrPeriods}"
                             Grid.Row="1"
                             Grid.Column="1"
                             Width="240"
                             HorizontalAlignment="Left"
                             Margin="0,0,0,5"
                             ToolTip="Number of years used when discounting recurring RR&amp;R and mitigation items. This period sets the CRF used to annualize RR&amp;R costs."/>
                    <TextBlock Grid.Row="2" Margin="0,0,5,5" Text="Base Year"/>
                    <TextBox Text="{Binding RrrBaseYear}"
                             Grid.Row="2"
                             Grid.Column="1"
                             Width="240"
                             HorizontalAlignment="Left"
                             Margin="0,0,0,5"
                             ToolTip="Reference year to which all RR&amp;R and mitigation costs are discounted. This year anchors the present value factors."/>
                    <DataGrid CanUserResizeColumns="True"
                              CanUserAddRows="True"
                              ItemsSource="{Binding RrrCostItems}"
                              AutoGenerateColumns="False"
                              Grid.Row="3"
                              Grid.ColumnSpan="2"
                              Height="150"
                              Margin="0,0,0,5"
                              ColumnWidth="SizeToHeader"
                              VerticalScrollBarVisibility="Auto">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Item" Binding="{Binding Item}">
                                <DataGridTextColumn.HeaderStyle>
                                    <Style TargetType="DataGridColumnHeader">
                                        <Setter Property="ToolTip" Value="Name of the repair, replacement, rehabilitation, or mitigation activity. The label tracks which item contributes to the RR&amp;R totals."/>
                                    </Style>
                                </DataGridTextColumn.HeaderStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="Future Cost">
                                <DataGridTextColumn.Binding>
                                    <Binding Path="FutureCost" Converter="{StaticResource CurrencyConverter}"/>
                                </DataGridTextColumn.Binding>
                                <DataGridTextColumn.HeaderStyle>
                                    <Style TargetType="DataGridColumnHeader">
                                        <Setter Property="ToolTip" Value="Cost of the activity stated in the year it occurs. This amount is discounted to present value for annualization."/>
                                    </Style>
                                </DataGridTextColumn.HeaderStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="Year" Binding="{Binding Year}">
                                <DataGridTextColumn.HeaderStyle>
                                    <Style TargetType="DataGridColumnHeader">
                                        <Setter Property="ToolTip" Value="Calendar year when the activity is scheduled. The year determines the discount exponent used in PV factors."/>
                                    </Style>
                                </DataGridTextColumn.HeaderStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="PV Factor" Binding="{Binding PvFactor}" IsReadOnly="True">
                                <DataGridTextColumn.HeaderStyle>
                                    <Style TargetType="DataGridColumnHeader">
                                        <Setter Property="ToolTip" Value="Present value factor computed from the discount rate and base year."/>
                                    </Style>
                                </DataGridTextColumn.HeaderStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="Present Value" IsReadOnly="True">
                                <DataGridTextColumn.Binding>
                                    <Binding Path="PresentValue" Converter="{StaticResource CurrencyConverter}"/>
                                </DataGridTextColumn.Binding>
                                <DataGridTextColumn.HeaderStyle>
                                    <Style TargetType="DataGridColumnHeader">
                                        <Setter Property="ToolTip" Value="Discounted present value of the future cost based on the PV factor."/>
                                    </Style>
                                </DataGridTextColumn.HeaderStyle>
                            </DataGridTextColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                    <Button Grid.Row="4"
                            Grid.ColumnSpan="2"
                            Margin="0,4,0,4"
                            Command="{Binding ResetRrrItemsCommand}"
                            HorizontalAlignment="Left"
                            ToolTip="Clear all RR&amp;R and mitigation entries from the table. Clearing removes their effect on updated and annualized RR&amp;R totals.">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE72C;" FontSize="16" Margin="0,0,6,0"/>
                            <TextBlock Text="Reset Table"/>
                        </StackPanel>
                    </Button>
                    <Button Grid.Row="5"
                            Grid.ColumnSpan="2"
                            Margin="0,5,0,5"
                            Command="{Binding ComputeRrrCommand}"
                            ToolTip="Discount the RR&amp;R / mitigation schedule using the settings above. This recalculates present value, updated cost, and annualized totals.">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <TextBlock FontFamily="Segoe MDL2 Assets"
                                       Text="&#xE8EF;"
                                       FontSize="18"
                                       Margin="0,0,6,0"/>
                            <TextBlock Text="Compute"/>
                        </StackPanel>
                    </Button>
                    <StackPanel Grid.Row="6" Grid.ColumnSpan="2">
                        <TextBlock Text="{Binding RrrUpdatedCost, Mode=OneWay, StringFormat=Updated Cost: {0:C2}}" ToolTip="Updated Cost = Present Value. This total feeds the annualized RR&amp;R amount." FontWeight="Bold" Margin="0,0,0,4"/>
                        <TextBlock Text="{Binding RrrAnnualized, Mode=OneWay, StringFormat=Annualized: {0:C2}}" ToolTip="Annualized = Updated Cost × CRF. This annualized value is scaled by storage percent in total cost." FontWeight="Bold"/>
                    </StackPanel>
                </Grid>
                <Border Style="{StaticResource Border.ResultInfo}" Margin="0">
                    <TextBlock TextWrapping="Wrap">
                        Present Value aggregates each scheduled cost using the discount rate and base year. The Updated Cost matches that total, and the Annualized figure then applies your capital recovery factor. Larger future costs or slower discounting will elevate every downstream total.
                    </TextBlock>
                </Border>
                <Border Style="{StaticResource Border.ResultInfo}" Margin="0,8,0,0">
                    <TextBlock TextWrapping="Wrap">
                        • PV Factor = 1 ÷ (1 + r)^(Year − Base Year); Present Value = Future Cost × PV Factor.
                        <LineBreak/>
                        • RRR Updated Cost = Σ Present Value.
                        <LineBreak/>
                        • Annualized RR&amp;R = RRR Updated Cost × CRF(r, periods), where CRF follows r(1 + r)ⁿ ÷ ((1 + r)ⁿ − 1) or 1/n when r = 0.
                    </TextBlock>
                </Border>
            </StackPanel>
        </TabItem>
        <TabItem Header="Total Annual Cost">
            <StackPanel Margin="10">
                <Border Style="{StaticResource Border.Explainer}" Margin="0,0,0,12">
                    <StackPanel>
                        <Grid VerticalAlignment="Center">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock FontFamily="Segoe MDL2 Assets"
                                       Text=""
                                       FontSize="18"
                                       Foreground="{DynamicResource App.Accent}"
                                       Margin="0,0,8,0"/>
                            <TextBlock Grid.Column="1"
                                       Text="Compare Annual Cost Scenarios"
                                       FontWeight="Bold"
                                       Foreground="{DynamicResource App.Accent}"
                                       TextWrapping="Wrap"/>
                        </Grid>
                        <TextBlock TextWrapping="Wrap" Margin="0,6,0,0">
                            Define up to two capital recovery scenarios. Each uses its own discount rate and analysis period to annualize the updated costs, then layers on scaled joint O&amp;M and RR&amp;R/mitigation values.
                        </TextBlock>
                    </StackPanel>
                </Border>
                <Grid Margin="0,10,0,10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Margin="0,0,5,5" Text="Discount Rate 1 (%)"/>
                    <TextBox Text="{Binding DiscountRate1}"
                             Grid.Column="1"
                             Width="240"
                             HorizontalAlignment="Left"
                             Margin="0,0,0,5"
                             ToolTip="Discount rate used for the first annualization scenario. This rate drives the CRF used to annualize updated costs in Cost 1."/>
                    <TextBlock Grid.Row="1" Margin="0,0,5,5" Text="Analysis Period 1"/>
                    <TextBox Text="{Binding AnalysisPeriod1}"
                             Grid.Row="1"
                             Grid.Column="1"
                             Width="240"
                             HorizontalAlignment="Left"
                             Margin="0,0,0,5"
                             ToolTip="Number of years in the first capital recovery scenario. This period, with the discount rate, defines the CRF for Cost 1."/>
                    <TextBlock Grid.Row="2" Margin="0,0,5,5" Text="Discount Rate 2 (%)"/>
                    <TextBox Text="{Binding DiscountRate2}"
                             Grid.Row="2"
                             Grid.Column="1"
                             Width="240"
                             HorizontalAlignment="Left"
                             Margin="0,0,0,5"
                             ToolTip="Discount rate for the second comparison scenario. This rate drives the CRF used to annualize updated costs in Cost 2."/>
                    <TextBlock Grid.Row="3" Margin="0,0,5,5" Text="Analysis Period 2"/>
                    <TextBox Text="{Binding AnalysisPeriod2}"
                             Grid.Row="3"
                             Grid.Column="1"
                             Width="240"
                             HorizontalAlignment="Left"
                             Margin="0,0,0,5"
                             ToolTip="Years covered by the second capital recovery scenario. This period, with the discount rate, defines the CRF for Cost 2."/>
                    <Button Grid.Row="4"
                            Grid.ColumnSpan="2"
                            Margin="0,5,0,5"
                            Command="{Binding ComputeTotalCommand}"
                            ToolTip="Combine capital, O&amp;M, and RR&amp;R values to update the allocation scenarios. This refreshes the total annual cost outputs for both scenarios.">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <TextBlock FontFamily="Segoe MDL2 Assets"
                                       Text="&#xE8EF;"
                                       FontSize="18"
                                       Margin="0,0,6,0"/>
                            <TextBlock Text="Compute"/>
                        </StackPanel>
                    </Button>
                    <Grid Grid.Row="5" Grid.ColumnSpan="2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <GroupBox Header="Cost 1" Grid.Column="0" Margin="0,0,5,0">
                            <StackPanel>
                                <TextBlock Text="{Binding Percent, Mode=OneWay, StringFormat=P: {0:F5}}" ToolTip="Percent = Storage Recommendation / Total Usable Storage. This factor is applied to all scaled cost components."/>
                                <TextBlock Text="{Binding CostRecommendation, Mode=OneWay, StringFormat=Cost of Storage Recommendation: {0:C2}}" ToolTip="Cost Recommendation = Total Updated Cost × Percent. This is the scaled capital base before annualization."/>
                                <TextBlock Text="{Binding Capital1, Mode=OneWay, StringFormat=Annualized Storage Cost 1: {0:C2}}" ToolTip="Annualized Storage Cost 1 = Total Updated Cost × Percent × CRF1. This is the annualized capital component for Cost 1."/>
                                <TextBlock Text="{Binding OmScaled, Mode=OneWay, StringFormat=Joint O&amp;M: {0:C2}}" ToolTip="Joint O&amp;M = Total Joint O&amp;M × Percent. This is the O&amp;M component scaled by storage share."/>
                                <TextBlock Text="{Binding RrrScaled, Mode=OneWay, StringFormat=Annualized RR&amp;R/Mitigation: {0:C2}}" ToolTip="Annualized RR&amp;R/Mitigation = RRR Annualized × Percent. This scales annualized RR&amp;R to the storage share."/>
                                <TextBlock Text="{Binding Total1, Mode=OneWay, StringFormat=Total Annual Cost 1: {0:C2}}" ToolTip="Total Annual Cost 1 = Capital1 + Joint O&amp;M + Annualized RR&amp;R/Mitigation. This is the summed annual cost for scenario 1." FontWeight="Bold"/>
                            </StackPanel>
                        </GroupBox>
                        <GroupBox Header="Cost 2" Grid.Column="1" Margin="5,0,0,0">
                            <StackPanel>
                                <TextBlock Text="{Binding Percent, Mode=OneWay, StringFormat=P: {0:F5}}" ToolTip="Percent = Storage Recommendation / Total Usable Storage. This factor is applied to all scaled cost components."/>
                                <TextBlock Text="{Binding CostRecommendation, Mode=OneWay, StringFormat=Cost of Storage Recommendation: {0:C2}}" ToolTip="Cost Recommendation = Total Updated Cost × Percent. This is the scaled capital base before annualization."/>
                                <TextBlock Text="{Binding Capital2, Mode=OneWay, StringFormat=Annualized Storage Cost 2: {0:C2}}" ToolTip="Annualized Storage Cost 2 = Total Updated Cost × Percent × CRF2. This is the annualized capital component for Cost 2."/>
                                <TextBlock Text="{Binding OmScaled, Mode=OneWay, StringFormat=Joint O&amp;M: {0:C2}}" ToolTip="Joint O&amp;M = Total Joint O&amp;M × Percent. This is the O&amp;M component scaled by storage share."/>
                                <TextBlock Text="{Binding Total2, Mode=OneWay, StringFormat=Total Annual Cost 2: {0:C2}}" ToolTip="Total Annual Cost 2 = Capital2 + Joint O&amp;M. This is the summed annual cost for scenario 2." FontWeight="Bold"/>
                            </StackPanel>
                        </GroupBox>
                    </Grid>
                </Grid>
                <Border Style="{StaticResource Border.ResultInfo}" Margin="0">
                    <TextBlock TextWrapping="Wrap">
                        Cost 1 and Cost 2 let you compare alternative discounting assumptions. Lower discount rates or longer analysis periods increase the capital recovery factor and therefore annualized storage costs. Because joint O&amp;M and RR&amp;R values scale with the storage percentage, any change you make on earlier tabs will ripple into both scenarios here.
                    </TextBlock>
                </Border>
                <Border Style="{StaticResource Border.ResultInfo}" Margin="0,8,0,0">
                    <TextBlock TextWrapping="Wrap">
                        • Cost Recommendation = Total Updated Cost × Percent; Joint O&amp;M and RR&amp;R allocations scale as Total Joint O&amp;M × Percent and RRR Annualized × Percent.
                        <LineBreak/>
                        • Capital1 = Total Updated Cost × Percent × CRF(Discount Rate 1, Analysis Period 1); Capital2 mirrors this with the second rate and period.
                        <LineBreak/>
                        • Total Annual Cost 1 = Capital1 + Joint O&amp;M + Annualized RR&amp;R; Total Annual Cost 2 = Capital2 + Joint O&amp;M.
                    </TextBlock>
                </Border>
            </StackPanel>
        </TabItem>
            </TabControl>
            <Border Style="{StaticResource Border.ResultInfo}" Margin="0">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="" FontSize="18" Foreground="{DynamicResource App.Accent}" Margin="0,0,8,0"/>
                        <TextBlock Text="Result guidance" FontWeight="Bold" Foreground="{DynamicResource App.Accent}"/>
                    </StackPanel>
                    <TextBlock TextWrapping="Wrap" Margin="0,6,0,0">
                        Storage Allocation, Updated RR&amp;R, and Total Annual Cost tabs feed the same allocation percentage and cost streams. Review the allocation tab first, then confirm how escalated costs, RR&amp;R schedules, and annualized totals change as you adjust discounting assumptions across scenarios.
                    </TextBlock>
                </StackPanel>
            </Border>
            <Border Style="{StaticResource Border.ResultInfo}" Margin="{StaticResource Margin.TopLarge}">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="" FontSize="18" Foreground="{DynamicResource App.Accent}" Margin="0,0,8,0"/>
                        <TextBlock Text="Workflow tips" FontWeight="Bold" Foreground="{DynamicResource App.Accent}"/>
                    </StackPanel>
                    <TextBlock TextWrapping="Wrap" Margin="0,6,0,0">
                        <Run Text="• Verify storage recommendation and total usable storage before comparing Cost 1 and Cost 2."/>
                        <LineBreak/>
                        <Run Text="• Recalculate capital recovery factors after adjusting discount rates or analysis periods."/>
                        <LineBreak/>
                        <Run Text="• Use the export to capture both storage allocation percentages and RR&amp;R assumptions for review."/>
                    </TextBlock>
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>
</UserControl>
