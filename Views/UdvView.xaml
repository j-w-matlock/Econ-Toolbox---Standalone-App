<UserControl x:Class="EconToolbox.Desktop.Views.UdvView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="clr-namespace:EconToolbox.Desktop.Views.Controls"
             Background="{StaticResource Brush.SurfaceAlt}"
             SnapsToDevicePixels="True"
             UseLayoutRounding="True">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Themes/Design.xaml"/>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>
    <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto" Padding="{StaticResource Padding.Card}">
        <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Border Grid.Row="0" Style="{StaticResource Border.Explainer}">
            <StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <Viewbox Width="28" Height="28" Margin="{StaticResource Margin.Inline}">
                        <Canvas Width="28" Height="28">
                            <Polygon Points="14,3 8,13 11,13 6,20 22,20 17,13 20,13" Fill="#C23E64"/>
                            <Rectangle Width="3" Height="6" Fill="#7A1F3E" RadiusX="1" RadiusY="1" Canvas.Left="12.5" Canvas.Top="20"/>
                            <Rectangle Width="18" Height="3" Fill="#C23E64" RadiusX="1.5" RadiusY="1.5" Canvas.Left="5" Canvas.Top="19"/>
                            <Rectangle Width="2.5" Height="5" Fill="#7A1F3E" RadiusX="1" RadiusY="1" Canvas.Left="7" Canvas.Top="21.5"/>
                            <Rectangle Width="2.5" Height="5" Fill="#7A1F3E" RadiusX="1" RadiusY="1" Canvas.Left="18.5" Canvas.Top="21.5"/>
                            <Path Data="M5,25 L23,25" Stroke="#C23E64" StrokeThickness="1.8" StrokeEndLineCap="Round" StrokeStartLineCap="Round"/>
                        </Canvas>
                    </Viewbox>
                    <TextBlock Text="Unit Day Value Overview"
                               FontWeight="Bold"
                               FontSize="16"
                               Foreground="{StaticResource Brush.Primary}"/>
                </StackPanel>
                <TextBlock TextWrapping="Wrap"
                           Margin="0,6,0,0">
                    Choose the recreation and activity classification, then supply a point score, season length, and visitation cadence. Points must align with the table order to return the correct value tier. Use the Calculate button at the bottom of the window whenever you change inputs so the unit day value stays synchronized.
                </TextBlock>
            </StackPanel>
        </Border>
        <StackPanel Orientation="Horizontal" Grid.Row="1" Margin="{StaticResource Margin.Stack}">
            <StackPanel.Style>
                <Style TargetType="StackPanel">
                    <Setter Property="Orientation" Value="Horizontal"/>
                    <Setter Property="HorizontalAlignment" Value="Stretch"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource WidthToLayoutModeConverter}}"
                                     Value="Narrow">
                            <Setter Property="Orientation" Value="Vertical"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </StackPanel.Style>
            <StackPanel Margin="{StaticResource Margin.Inline}">
                <TextBlock>
                    <InlineUIContainer BaselineAlignment="Center">
                        <ContentControl Style="{StaticResource Content.InfoIcon}"
                                        ToolTip="Choose the overall recreation classification to filter available activity point tables."/>
                    </InlineUIContainer>
                    <Run Text="Recreation Type"/>
                </TextBlock>
                <ComboBox ItemsSource="{Binding RecreationTypes}" SelectedItem="{Binding RecreationType}" MinWidth="150"/>
            </StackPanel>
            <StackPanel Margin="{StaticResource Margin.Inline}">
                <TextBlock>
                    <InlineUIContainer BaselineAlignment="Center">
                        <ContentControl Style="{StaticResource Content.InfoIcon}"
                                        ToolTip="Select the specific activity that matches your study to retrieve the proper unit day scale."/>
                    </InlineUIContainer>
                    <Run Text="Activity Type"/>
                </TextBlock>
                <ComboBox ItemsSource="{Binding ActivityTypes}" SelectedItem="{Binding ActivityType}" MinWidth="200"/>
            </StackPanel>
        </StackPanel>
        <Grid Grid.Row="2"
              Margin="{StaticResource Margin.Stack}"
              Grid.IsSharedSizeScope="True">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" SharedSizeGroup="UdvLabel"/>
                <ColumnDefinition Width="Auto" SharedSizeGroup="UdvValue"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <StackPanel Grid.Row="0"
                        Grid.Column="0"
                        Orientation="Horizontal"
                        VerticalAlignment="Center"
                        Margin="{StaticResource Margin.Inline}">
                <ContentControl Style="{StaticResource Content.InfoIcon}"
                                ToolTip="Enter the point score from the Unit Day Value table that reflects recreation quality."/>
                <TextBlock Text="Point Value" Margin="4,0,0,0" VerticalAlignment="Center"/>
            </StackPanel>
            <TextBox Grid.Row="0"
                     Grid.Column="1"
                     Text="{Binding Points, UpdateSourceTrigger=PropertyChanged}"
                     MinWidth="80"
                     Margin="12,0,0,0"
                     TextAlignment="Right"/>

            <StackPanel Grid.Row="1"
                        Grid.Column="0"
                        Orientation="Horizontal"
                        VerticalAlignment="Center"
                        Margin="{StaticResource Margin.Inline}">
                <ContentControl Style="{StaticResource Content.InfoIcon}"
                                ToolTip="Provide the number of days in the recreation season that will host visitors."/>
                <TextBlock Text="Season Length (days)" Margin="4,0,0,0" VerticalAlignment="Center"/>
            </StackPanel>
            <TextBox Grid.Row="1"
                     Grid.Column="1"
                     Text="{Binding SeasonDays, UpdateSourceTrigger=PropertyChanged}"
                     MinWidth="100"
                     Margin="12,0,0,0"
                     TextAlignment="Right"/>

            <StackPanel Grid.Row="2"
                        Grid.Column="0"
                        Orientation="Horizontal"
                        VerticalAlignment="Center"
                        Margin="{StaticResource Margin.Inline}">
                <ContentControl Style="{StaticResource Content.InfoIcon}"
                                ToolTip="Enter visitation as daily, monthly, or yearly figures. Adjust the selector to match your data cadence."/>
                <TextBlock Text="Visitation Input" Margin="4,0,0,0" VerticalAlignment="Center"/>
            </StackPanel>
            <StackPanel Grid.Row="2"
                        Grid.Column="1"
                        Orientation="Horizontal"
                        Margin="12,0,0,0"
                        VerticalAlignment="Center">
                <TextBox Text="{Binding VisitationInput, UpdateSourceTrigger=PropertyChanged}"
                         MinWidth="100"
                         TextAlignment="Right"/>
                <ComboBox ItemsSource="{Binding VisitationPeriods}"
                          SelectedItem="{Binding VisitationPeriod}"
                          Margin="8,0,0,0"
                          MinWidth="120"/>
            </StackPanel>

            <StackPanel Grid.Row="3"
                        Grid.Column="0"
                        Orientation="Horizontal"
                        VerticalAlignment="Center"
                        Margin="{StaticResource Margin.Inline}">
                <ContentControl Style="{StaticResource Content.InfoIcon}"
                                ToolTip="Calculated total user days for the season based on visitation settings."/>
                <TextBlock Text="Total User Days" Margin="4,0,0,0" VerticalAlignment="Center"/>
            </StackPanel>
            <TextBlock Grid.Row="3"
                       Grid.Column="1"
                       Text="{Binding TotalUserDays, StringFormat={}{0:N0}}"
                       Margin="12,0,0,0"
                       VerticalAlignment="Center"
                       FontWeight="SemiBold"/>
        </Grid>
        <Border Grid.Row="3" Style="{StaticResource Border.ResultInfo}">
            <StackPanel>
                <TextBlock Text="Historical Visitation Data" FontWeight="Bold"/>
                <TextBlock TextWrapping="Wrap" Margin="{StaticResource Margin.TopXSmall}">
                    Provide historic visitation observations in the table. You can type directly or paste multiple rows from a spreadsheet. The median of these values will replace the visitation input above.
                </TextBlock>
                <DataGrid ItemsSource="{Binding HistoricalVisitationRows}"
                          AutoGenerateColumns="False"
                          CanUserAddRows="True"
                          CanUserDeleteRows="True"
                          PreviewKeyDown="HistoricalVisitationGrid_PreviewKeyDown"
                          HeadersVisibility="Column"
                          Margin="0,8,0,8"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto">
                    <DataGrid.Columns>
                        <DataGridTextColumn Binding="{Binding Label, UpdateSourceTrigger=PropertyChanged}"
                                            Width="2*">
                            <DataGridTextColumn.Header>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Label (optional)"/>
                                </StackPanel>
                            </DataGridTextColumn.Header>
                        </DataGridTextColumn>
                        <DataGridTextColumn Binding="{Binding VisitationText, UpdateSourceTrigger=PropertyChanged}"
                                            Width="*">
                            <DataGridTextColumn.Header>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Visitation"/>
                                </StackPanel>
                            </DataGridTextColumn.Header>
                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="Calculate Median"
                            Command="{Binding ComputeMedianCommand}"
                            Width="180"
                            ToolTip="Compute the median visitation value from the historical records above."/>
                    <TextBlock Margin="12,0,0,0"
                               Visibility="{Binding HasHistoricalMedian, Converter={StaticResource BoolToVisibilityConverter}}">
                        <Run Text="Median: "/>
                        <Run Text="{Binding HistoricalMedianVisitation, Mode=OneWay, StringFormat={}{0:N0}}"/>
                        <Run Text=" visitors"/>
                        <Run Text="{Binding HistoricalObservationCount, Mode=OneWay, StringFormat=  ({0} values)}"/>
                    </TextBlock>
                </StackPanel>
                <TextBlock Margin="0,4,0,0"
                           Foreground="#B71C1C"
                           Visibility="{Binding HasHistoricalDataError, Converter={StaticResource BoolToVisibilityConverter}}"
                           Text="{Binding HistoricalDataError}"/>
            </StackPanel>
        </Border>
        <Border Grid.Row="4" Background="{StaticResource Brush.HighlightBackground}" BorderBrush="{StaticResource Brush.HighlightBorder}" BorderThickness="1" CornerRadius="8" Padding="{StaticResource Padding.Content}" Margin="{StaticResource Margin.Stack}">
            <StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Unit Day Value:" FontWeight="Bold"/>
                    <TextBlock Text="{Binding UnitDayValue, StringFormat={}{0:C2}}" Margin="6,0,0,0" FontWeight="SemiBold"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,4,0,0">
                    <TextBlock Text="Annual Recreation Benefit:" FontWeight="Bold"/>
                    <TextBlock Text="{Binding AnnualRecreationBenefit, StringFormat={}{0:C2}}" Margin="6,0,0,0" FontWeight="SemiBold"/>
                </StackPanel>
                <TextBlock TextWrapping="Wrap" Margin="{StaticResource Margin.TopXSmall}">
                    This total monetizes recreation by multiplying the unit day value with the total user days derived from your season length and visitation cadence. Raising the point score moves you to a higher value tier, while longer seasons or higher visitation proportionally increase the benefit.
                </TextBlock>
            </StackPanel>
        </Border>
        <Border Grid.Row="5" Background="{StaticResource Brush.Surface}" BorderBrush="{StaticResource Brush.Border}" BorderThickness="1" CornerRadius="8" Padding="{StaticResource Padding.Content}" Margin="{StaticResource Margin.Stack}">
            <StackPanel>
                <TextBox Text="{Binding ChartTitle, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         FontSize="16"
                         FontWeight="SemiBold"
                         HorizontalAlignment="Center"
                         Margin="0,0,0,8"
                         BorderThickness="0"
                         Background="Transparent"
                         TextAlignment="Center"
                         HorizontalContentAlignment="Center"/>
                <TextBlock Text="Line chart showing how unit day values rise with higher point scores. The selected point overlays the active recreation and activity choice."
                           TextWrapping="Wrap"
                           Foreground="{StaticResource Brush.TextSecondary}"
                           Margin="0,0,0,12"/>
                <ItemsControl ItemsSource="{Binding LegendItems}"
                              Margin="0,0,0,12">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" Margin="0,0,12,4">
                                <Ellipse Width="12"
                                         Height="12"
                                         Fill="{Binding Color}"
                                         Stroke="{StaticResource Brush.Border}"
                                         StrokeThickness="0.5"
                                         Margin="0,0,6,0"/>
                                <TextBlock Text="{Binding Name}"
                                           VerticalAlignment="Center"/>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                <Border Background="{StaticResource Brush.ChartFill}"
                        BorderBrush="{StaticResource Brush.Border}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="8">
                    <controls:LineGraphControl Height="320"
                                               MinHeight="240"
                                               Series="{Binding ChartSeries}"
                                               EmptyMessage="{Binding ChartStatusMessage}"
                                               XAxisLabelPrefix="Points "
                                               XAxisLabelFormat="N0"
                                               YAxisLabelPrefix="UDV "
                                               YAxisLabelFormat="C2"/>
                </Border>
            </StackPanel>
        </Border>
        <Border Grid.Row="6" Background="{StaticResource Brush.Surface}" BorderBrush="{StaticResource Brush.HighlightBorder}" BorderThickness="1" CornerRadius="8" Padding="{StaticResource Padding.Content}">
            <StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock FontFamily="Segoe MDL2 Assets" Text="" FontSize="18" Foreground="{StaticResource Brush.Primary}" Margin="{StaticResource Margin.Inline}"/>
                    <TextBlock Text="Point Scale Reference" FontWeight="Bold" Foreground="{StaticResource Brush.Primary}"/>
                </StackPanel>
                <TextBlock TextWrapping="Wrap" FontSize="12" Margin="{StaticResource Margin.Stack}">
                    Reference this table to ensure your point selection matches the published ranges. The highlighted unit day value is chosen by matching your point entry to the correct column.
                </TextBlock>
                <DataGrid ItemsSource="{Binding Table}" AutoGenerateColumns="False" CanUserAddRows="False" ScrollViewer.HorizontalScrollBarVisibility="Auto" ScrollViewer.VerticalScrollBarVisibility="Auto">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Points" Binding="{Binding Points}"/>
                        <DataGridTextColumn Header="General Recreation">
                            <DataGridTextColumn.Binding>
                                <Binding Path="GeneralRecreation" StringFormat="{}{0:C2}"/>
                            </DataGridTextColumn.Binding>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="General Fishing &amp; Hunting">
                            <DataGridTextColumn.Binding>
                                <Binding Path="GeneralFishingHunting" StringFormat="{}{0:C2}"/>
                            </DataGridTextColumn.Binding>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Specialized Fishing &amp; Hunting">
                            <DataGridTextColumn.Binding>
                                <Binding Path="SpecializedFishingHunting" StringFormat="{}{0:C2}"/>
                            </DataGridTextColumn.Binding>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Specialized Recreation">
                            <DataGridTextColumn.Binding>
                                <Binding Path="SpecializedRecreation" StringFormat="{}{0:C2}"/>
                            </DataGridTextColumn.Binding>
                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </StackPanel>
        </Border>
        <StackPanel Grid.Row="7" Margin="{StaticResource Margin.Stack}">
            <Border Style="{StaticResource Border.ResultInfo}">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="" FontSize="18" Foreground="{StaticResource Brush.Primary}" Margin="0,0,8,0"/>
                        <TextBlock Text="Result guidance" FontWeight="Bold" Foreground="{StaticResource Brush.Primary}"/>
                    </StackPanel>
                    <TextBlock TextWrapping="Wrap" Margin="{StaticResource Margin.TopSmall}">
                        The highlighted Unit Day Value and Annual Recreation Benefit respond immediately to changes in points, visitation cadence, or season length. Use them to explain how quality adjustments move you between table tiers while user days scale the monetized benefit.
                    </TextBlock>
                </StackPanel>
            </Border>
            <Border Style="{StaticResource Border.ResultInfo}" Margin="0,12,0,0">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="" FontSize="18" Foreground="{StaticResource Brush.Primary}" Margin="0,0,8,0"/>
                        <TextBlock Text="Workflow tips" FontWeight="Bold" Foreground="{StaticResource Brush.Primary}"/>
                    </StackPanel>
                    <TextBlock TextWrapping="Wrap" Margin="{StaticResource Margin.TopSmall}">
                        <Run Text="• Verify point selections against the published ranges before interpreting the UDV."/>
                        <LineBreak/>
                        <Run Text="• Revisit visitation cadence and season length if user days look too high or low."/>
                        <LineBreak/>
                        <Run Text="• Use the export to capture both the selected point tier and the calculated annual benefit."/>
                    </TextBlock>
                </StackPanel>
            </Border>
            <Border Style="{StaticResource Border.ResultInfo}" Margin="0,12,0,0">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="" FontSize="18" Foreground="{StaticResource Brush.Primary}" Margin="0,0,8,0"/>
                        <TextBlock Text="Formula Reference" FontWeight="Bold" Foreground="{StaticResource Brush.Primary}"/>
                    </StackPanel>
                    <TextBlock TextWrapping="Wrap" Margin="{StaticResource Margin.TopSmall}">
                        <Run Text="• Unit day values are interpolated between table breakpoints: UDV = yᵢ + (Points − xᵢ)/(xᵢ₊₁ − xᵢ) × (yᵢ₊₁ − yᵢ)."/>
                        <LineBreak/>
                        <Run Text="• Total user days come from visitation cadence, season length, and group size settings in the header inputs."/>
                        <LineBreak/>
                        <Run Text="• Annual recreation benefit multiplies the interpolated UDV by the total user days: Benefit = UDV × User Days."/>
                    </TextBlock>
                </StackPanel>
            </Border>
        </StackPanel>
        </Grid>
    </ScrollViewer>
</UserControl>
