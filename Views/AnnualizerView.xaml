<UserControl x:Class="EconToolbox.Desktop.Views.AnnualizerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:EconToolbox.Desktop.Converters"
             xmlns:sys="clr-namespace:System;assembly=System.Runtime"
             Background="{DynamicResource App.SurfaceAlt}"
             SnapsToDevicePixels="True"
             UseLayoutRounding="True">
    <Grid>
        <ScrollViewer Focusable="False"
                      Style="{StaticResource ScrollViewer.Page}">
            <TabControl Margin="0"
                        Padding="0"
                        HorizontalContentAlignment="Stretch">
                <TabItem Header="Annualization" Padding="0">
                    <StackPanel Margin="0">
                        <Border Style="{StaticResource Border.Explainer}">
                            <StackPanel>
                            <Grid VerticalAlignment="Center">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock FontFamily="Segoe MDL2 Assets"
                                           Text=""
                                           FontSize="18"
                                           Foreground="{DynamicResource App.Accent}"
                                           Margin="0,0,8,0"/>
                                <TextBlock Grid.Column="1"
                                           Text="Cost Annualization Workflow"
                                           FontWeight="Bold"
                                           FontSize="16"
                                           Foreground="{DynamicResource App.Accent}"
                                           TextWrapping="Wrap"/>
                            </Grid>
                                <TextBlock TextWrapping="Wrap"
                                           Margin="0,6,0,0">
                                    <Run Text="• Document upfront investments, financing assumptions, and the analysis period."/>
                                    <LineBreak/>
                                    <Run Text="• Capture construction cash flow in the IDC schedule and list future costs in the year they occur."/>
                                    <LineBreak/>
                                    <Run Text="• Provide annual O&amp;M and annual benefits so the tool can translate capital outlays into comparable annual metrics."/>
                                    <LineBreak/>
                                    <Run Text="• Select Calculate after any edits so the tables, charts, and exports remain synchronized."/>
                                </TextBlock>
                            </StackPanel>
                        </Border>

                        <Border Background="{DynamicResource App.Surface}"
                                CornerRadius="8"
                                Padding="{StaticResource Padding.Card}"
                                BorderBrush="{DynamicResource App.Border}"
                                BorderThickness="1"
                                Margin="0,16,0,0">
                            <StackPanel>
                                <TextBlock Text="Shared Timing &amp; Discounting"
                                           FontSize="15"
                                           FontWeight="SemiBold"/>
                                <TextBlock Style="{StaticResource Text.Body}" Margin="0,4,0,12" TextWrapping="Wrap">
                                    Apply consistent timing, period, and IDC assumptions before refining each scenario below.
                                </TextBlock>
                                <Grid Margin="0,4,0,0">
                                    <Grid.Resources>
                                        <Style TargetType="TextBlock" x:Key="AnnualizerLabelStyle">
                                            <Setter Property="FontWeight" Value="SemiBold"/>
                                            <Setter Property="VerticalAlignment" Value="Center"/>
                                        </Style>
                                    </Grid.Resources>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="2*"/>
                                        <ColumnDefinition Width="3*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <StackPanel Grid.Row="0" Grid.Column="0" Orientation="Horizontal" Margin="0,0,12,8">
                                        <TextBlock Text="Base Year" Style="{StaticResource AnnualizerLabelStyle}"/>
                                    </StackPanel>
                                    <TextBox Grid.Row="0" Grid.Column="1"
                                             Text="{Binding BaseYear, Converter={StaticResource SafeNumberConverter}}"
                                             HorizontalContentAlignment="Right"
                                             ToolTip="Reference year that anchors discounting for future costs and benefits. This sets the base for present value factors across all annualization calculations."
                                             Margin="0,0,0,8"/>

                                    <StackPanel Grid.Row="1" Grid.Column="0" Orientation="Horizontal" Margin="0,0,12,8">
                                        <TextBlock Text="Analysis Period" Style="{StaticResource AnnualizerLabelStyle}"/>
                                    </StackPanel>
                                    <TextBox Grid.Row="1" Grid.Column="1"
                                             Text="{Binding AnalysisPeriod, Converter={StaticResource SafeNumberConverter}}"
                                             HorizontalContentAlignment="Right"
                                             ToolTip="Number of periods for capital recovery. This length drives the capital recovery factor and annualized cost results."
                                             Margin="0,0,0,8"/>

                                    <StackPanel Grid.Row="2" Grid.Column="0" Orientation="Horizontal" Margin="0,0,12,8">
                                        <TextBlock Text="Construction Months" Style="{StaticResource AnnualizerLabelStyle}"/>
                                    </StackPanel>
                                    <TextBox Grid.Row="2" Grid.Column="1"
                                             Text="{Binding ConstructionMonths, Converter={StaticResource SafeNumberConverter}}"
                                             HorizontalContentAlignment="Right"
                                             ToolTip="Total construction duration in months used to accumulate IDC. Longer durations increase the time interest accrues on construction outlays."
                                             Margin="0,0,0,8"/>

                                    <StackPanel Grid.Row="3" Grid.Column="0" Orientation="Horizontal" Margin="0,0,12,8">
                                        <TextBlock Text="IDC Timing Assumption" Style="{StaticResource AnnualizerLabelStyle}"/>
                                    </StackPanel>
                                    <ComboBox Grid.Row="3" Grid.Column="1"
                                              ItemsSource="{Binding IdcTimingOptions}"
                                              SelectedItem="{Binding IdcTimingBasis}"
                                              ToolTip="Select whether IDC accrues from the beginning, middle, or end of each construction month when no detailed schedule is provided. The timing assumption shifts how much interest is applied within each month."
                                              Margin="0,0,0,8"/>

                                    <StackPanel Grid.Row="4" Grid.Column="0" Orientation="Horizontal" Margin="0,0,12,8">
                                        <TextBlock Text="Calculate Interest at Period" Style="{StaticResource AnnualizerLabelStyle}"/>
                                    </StackPanel>
                                    <CheckBox Grid.Row="4" Grid.Column="1"
                                              Content="Enable period-based IDC"
                                              IsChecked="{Binding CalculateInterestAtPeriod}"
                                              ToolTip="Toggle to calculate IDC using period-based first and last payment assumptions. Enabling this changes the IDC timing logic and alters the resulting IDC total."
                                              Margin="0,0,0,8"/>

                                    <StackPanel Grid.Row="5" Grid.Column="0" Orientation="Horizontal" Margin="0,0,12,8">
                                        <TextBlock Text="First Payment Timing" Style="{StaticResource AnnualizerLabelStyle}"/>
                                    </StackPanel>
                                    <ComboBox Grid.Row="5" Grid.Column="1"
                                              ItemsSource="{Binding IdcFirstPaymentOptions}"
                                              SelectedItem="{Binding IdcFirstPaymentTiming}"
                                              ToolTip="Choose when the first payment occurs within the construction period for period-based IDC. The selected timing changes how many periods of interest are applied to the first outlay."
                                              Margin="0,0,0,8">
                                        <ComboBox.Style>
                                            <Style TargetType="ComboBox">
                                                <Setter Property="IsEnabled" Value="False"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding CalculateInterestAtPeriod}" Value="True">
                                                        <Setter Property="IsEnabled" Value="True"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </ComboBox.Style>
                                    </ComboBox>

                                    <StackPanel Grid.Row="6" Grid.Column="0" Orientation="Horizontal" Margin="0,0,12,0">
                                        <TextBlock Text="Last Payment Timing" Style="{StaticResource AnnualizerLabelStyle}"/>
                                    </StackPanel>
                                    <ComboBox Grid.Row="6" Grid.Column="1"
                                              ItemsSource="{Binding IdcLastPaymentOptions}"
                                              SelectedItem="{Binding IdcLastPaymentTiming}"
                                              ToolTip="Define the timing of the final payment when using period-based IDC. This affects how much interest is applied to the last payment period.">
                                        <ComboBox.Style>
                                            <Style TargetType="ComboBox">
                                                <Setter Property="IsEnabled" Value="False"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding CalculateInterestAtPeriod}" Value="True">
                                                        <Setter Property="IsEnabled" Value="True"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </ComboBox.Style>
                                    </ComboBox>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <Border Background="{DynamicResource App.Surface}"
                                CornerRadius="8"
                                Padding="{StaticResource Padding.Card}"
                                BorderBrush="{DynamicResource App.Border}"
                                BorderThickness="1"
                                Margin="0,16,0,0">
                            <StackPanel>
                                <TextBlock Text="Scenario Inputs"
                                           FontSize="15"
                                           FontWeight="SemiBold"/>
                                <TextBlock Style="{StaticResource Text.Body}" Margin="0,4,0,8" TextWrapping="Wrap">
                                    Enter all annualization inputs in one table. Add rows for alternative scenarios and select a row to update the rest of the worksheet.
                                </TextBlock>
                                <DataGrid CanUserResizeColumns="True" ItemsSource="{Binding ScenarioComparisons}"
                                          SelectedItem="{Binding SelectedScenario, Mode=TwoWay}"
                                          AutoGenerateColumns="False"
                                          HeadersVisibility="Column"
                                          ColumnWidth="SizeToHeader"
                                          Margin="0,8,0,0">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Scenario Name"
                                                            Binding="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                            Width="SizeToHeader">
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Descriptive name for the scenario. This label appears in comparisons, charts, and exports."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                        <DataGridTextColumn Header="First Cost"
                                                            Binding="{Binding FirstCost, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, Converter={StaticResource CurrencyConverter}}"
                                                            Width="SizeToHeader">
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Initial capital investment entered in current dollars. This value is annualized with the rate and period inputs."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                        <DataGridTextColumn Header="Rate (%)"
                                                            Binding="{Binding Rate, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, Converter={StaticResource SafeNumberConverter}}"
                                                            Width="SizeToHeader">
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Discount rate applied to the scenario. This rate drives the capital recovery factor and annualized costs."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                        <DataGridTextColumn Header="Annual O&amp;M"
                                                            Binding="{Binding AnnualOm, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, Converter={StaticResource CurrencyConverter}}"
                                                            Width="SizeToHeader">
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Annual operations and maintenance expense. This is added to annualized capital costs for total annual cost."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                        <DataGridTextColumn Header="Annual Benefits"
                                                            Binding="{Binding AnnualBenefits, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, Converter={StaticResource CurrencyConverter}}"
                                                            Width="SizeToHeader">
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Annual benefit estimate for the scenario. Combined with annual costs to compute the benefit-cost ratio."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                        <DataGridTextColumn Header="Annual Cost"
                                                            Binding="{Binding AnnualCost, StringFormat=C0}"
                                                            IsReadOnly="True"
                                                            Width="SizeToHeader">
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Calculated total annual cost (annualized capital + annual O&amp;M). Updates after recalculation."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                        <DataGridTextColumn Header="BCR"
                                                            Binding="{Binding Bcr, StringFormat=F2}"
                                                            IsReadOnly="True"
                                                            Width="SizeToHeader">
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Benefit-cost ratio (annual benefits ÷ annual cost). Values above 1 indicate benefits exceed costs."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                        <DataGridTextColumn Header="Unity BCR First Cost"
                                                            Binding="{Binding UnityBcrFirstCost, StringFormat=C0}"
                                                            IsReadOnly="True"
                                                            Width="SizeToHeader">
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="First cost scaled to a unity benefit-cost ratio. This helps benchmark the capital level that yields BCR = 1."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                        <DataGridTextColumn Header="IDC"
                                                            Binding="{Binding Idc, StringFormat=C0}"
                                                            IsReadOnly="True"
                                                            Width="SizeToHeader">
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Interest during construction computed from the IDC schedule and timing assumptions."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                        <DataGridTextColumn Header="CRF"
                                                            Binding="{Binding Crf, StringFormat=F5}"
                                                            IsReadOnly="True"
                                                            Width="SizeToHeader">
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Capital recovery factor derived from rate and analysis period. Used to annualize the first cost."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                        <DataGridTextColumn Header="Notes"
                                                            Binding="{Binding Notes, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                            Width="SizeToHeader">
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Optional notes to document scenario assumptions or special considerations."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                    </DataGrid.Columns>
                                </DataGrid>
                                <UniformGrid Columns="3" HorizontalAlignment="Left" Margin="0,10,0,0" Rows="1">
                                    <Button Command="{Binding AddScenarioComparisonCommand}" Width="150" Margin="0,0,8,0">
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="" Margin="{StaticResource Margin.Inline}"/>
                                            <TextBlock Text="Add Scenario"/>
                                        </StackPanel>
                                    </Button>
                                    <Button Command="{Binding ComputeCommand}" Width="150" Margin="0,0,8,0">
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="" Margin="{StaticResource Margin.Inline}"/>
                                            <TextBlock Text="Calculate"/>
                                        </StackPanel>
                                    </Button>
                                    <Button Command="{Binding ResetScenarioComparisonsCommand}" Width="150">
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="" Margin="{StaticResource Margin.Inline}"/>
                                            <TextBlock Text="Reset Table"/>
                                        </StackPanel>
                                    </Button>
                                </UniformGrid>
                            </StackPanel>
                        </Border>

                        <StackPanel Margin="0,24,0,0">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,0,8">
                                <TextBlock Text="IDC Schedule" FontWeight="SemiBold"/>
                            </StackPanel>
                            <Border Background="{DynamicResource App.Surface}" BorderBrush="{DynamicResource App.Border}" BorderThickness="1" CornerRadius="8" Padding="6">
                                <DataGrid CanUserResizeColumns="True" x:Name="IdcDataGrid" ItemsSource="{Binding IdcEntries}" AutoGenerateColumns="False" Margin="0" HeadersVisibility="Column" Validation.Error="DataGrid_OnError" ColumnWidth="SizeToHeader">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Cost">
                                            <DataGridTextColumn.Binding>
                                                <Binding Path="Cost" Converter="{StaticResource CurrencyConverter}"/>
                                            </DataGridTextColumn.Binding>
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Amount of capital spent in the specified month. Larger outlays increase IDC accrual and total capitalized cost."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                        <DataGridTextColumn Binding="{Binding Month, Converter={StaticResource SafeNumberConverter}}">
                                            <DataGridTextColumn.Header>Month Index</DataGridTextColumn.Header>
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Construction month index when the cost occurs, starting at 1. Earlier months accrue interest for more periods than later months."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                        <DataGridComboBoxColumn SelectedItemBinding="{Binding Timing}">
                                            <DataGridComboBoxColumn.Header>Timing</DataGridComboBoxColumn.Header>
                                            <DataGridComboBoxColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Select whether the cost hits at the beginning, midpoint, or end of the month. Earlier timing increases the interest applied within the month."/>
                                                </Style>
                                            </DataGridComboBoxColumn.HeaderStyle>
                                            <DataGridComboBoxColumn.ItemsSource>
                                                <x:Array Type="sys:String" xmlns:sys="clr-namespace:System;assembly=System.Runtime">
                                                    <sys:String>beginning</sys:String>
                                                    <sys:String>midpoint</sys:String>
                                                    <sys:String>end</sys:String>
                                                </x:Array>
                                            </DataGridComboBoxColumn.ItemsSource>
                                        </DataGridComboBoxColumn>
                                        <DataGridTextColumn Header="PV Factor" Binding="{Binding PvFactor}" IsReadOnly="True">
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Present value factor applied to the IDC cost based on timing and discount assumptions."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </Border>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,8,0,0">
                                <Button Command="{Binding ResetIdcCommand}" MinWidth="160" ToolTip="Clear all IDC schedule entries. Clearing resets IDC calculations that depend on the schedule.">
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="" Margin="{StaticResource Margin.Inline}"/>
                                        <TextBlock Text="Reset IDC Inputs"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </StackPanel>

                        <StackPanel Margin="0,24,0,0">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,0,8">
                                <TextBlock Text="Future Costs" FontWeight="SemiBold"/>
                            </StackPanel>
                            <Border Background="{DynamicResource App.Surface}" BorderBrush="{DynamicResource App.Border}" BorderThickness="1" CornerRadius="8" Padding="6">
                                <DataGrid CanUserResizeColumns="True" x:Name="FutureCostsDataGrid" ItemsSource="{Binding FutureCosts}" AutoGenerateColumns="False" Margin="0" Validation.Error="DataGrid_OnError" ColumnWidth="SizeToHeader">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Cost">
                                            <DataGridTextColumn.Binding>
                                                <Binding Path="Cost" Converter="{StaticResource CurrencyConverter}"/>
                                            </DataGridTextColumn.Binding>
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Future cost amount entered in nominal dollars. This amount is discounted to present value using the base year and timing."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                        <DataGridTextColumn Binding="{Binding Year, Converter={StaticResource SafeNumberConverter}}">
                                            <DataGridTextColumn.Header>Year</DataGridTextColumn.Header>
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Calendar year when the future cost will be incurred. The year determines how many periods the cost is discounted."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                        <DataGridComboBoxColumn SelectedItemBinding="{Binding Timing}">
                                            <DataGridComboBoxColumn.Header>Timing</DataGridComboBoxColumn.Header>
                                            <DataGridComboBoxColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Timing within the year to align present value factors. Earlier timing increases the discounted weight relative to later timing."/>
                                                </Style>
                                            </DataGridComboBoxColumn.HeaderStyle>
                                            <DataGridComboBoxColumn.ItemsSource>
                                                <x:Array Type="sys:String" xmlns:sys="clr-namespace:System;assembly=System.Runtime">
                                                    <sys:String>beginning</sys:String>
                                                    <sys:String>midpoint</sys:String>
                                                    <sys:String>end</sys:String>
                                                </x:Array>
                                            </DataGridComboBoxColumn.ItemsSource>
                                        </DataGridComboBoxColumn>
                                        <DataGridTextColumn Header="PV Factor" Binding="{Binding PvFactor}" IsReadOnly="True">
                                            <DataGridTextColumn.HeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="ToolTip" Value="Present value factor applied to the future cost based on the base year and timing assumption."/>
                                                </Style>
                                            </DataGridTextColumn.HeaderStyle>
                                        </DataGridTextColumn>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </Border>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,8,0,0">
                                <Button Command="{Binding ResetFutureCostsCommand}" MinWidth="160" ToolTip="Clear all future cost entries. Clearing removes their discounted impacts from totals.">
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="" Margin="{StaticResource Margin.Inline}"/>
                                        <TextBlock Text="Reset Future Costs"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                            </StackPanel>

                        <StackPanel Margin="{StaticResource Margin.StackLarge}">
                            <Border Style="{StaticResource Border.ResultInfo}">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                        <TextBlock FontFamily="Segoe MDL2 Assets"
                                                   Text=""
                                                   FontSize="18"
                                                   Foreground="{DynamicResource App.Accent}"
                                                   Margin="0,0,8,0"/>
                                        <TextBlock Text="Result guidance"
                                                   FontWeight="Bold"
                                                   Foreground="{DynamicResource App.Accent}"/>
                                    </StackPanel>
                                    <TextBlock Style="{StaticResource Text.Body}" TextWrapping="Wrap" Margin="{StaticResource Margin.TopSmall}">
                                        IDC, Total Investment, CRF, Annual Cost, and BCR update together. Confirm IDC before reviewing total investment, then use CRF and Annual Cost to explain how first cost, future costs, and O&amp;M translate into an annualized value and economic justification.
                                    </TextBlock>
                                </StackPanel>
                            </Border>
                            <Border Style="{StaticResource Border.ResultInfo}" Margin="0,12,0,0">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                        <TextBlock FontFamily="Segoe MDL2 Assets"
                                                   Text=""
                                                   FontSize="18"
                                                   Foreground="{DynamicResource App.Accent}"
                                                   Margin="0,0,8,0"/>
                                        <TextBlock Text="Formula Reference"
                                                   FontWeight="Bold"
                                                   Foreground="{DynamicResource App.Accent}"/>
                                    </StackPanel>
                                    <TextBlock Style="{StaticResource Text.Body}" TextWrapping="Wrap" Margin="{StaticResource Margin.TopSmall}">
                                        <Run Text="• Future cost present values use PV = cost × (1 + r)⁻ⁿ where n equals the year offset plus the timing fraction (0 for beginning, 0.5 for middle, 1 for end)."/>
                                        <LineBreak/>
                                        <Run Text="• Monthly IDC schedules accumulate as Σ costₙ × r/12 × max(0, totalMonths − eventMonthₙ); period-based IDC uses the same monthly rate but extends to the chosen first/last payment boundaries."/>
                                        <LineBreak/>
                                        <Run Text="• Total Investment = First Cost + IDC + Σ present value of future costs."/>
                                        <LineBreak/>
                                        <Run Text="• The capital recovery factor is CRF = r(1 + r)ⁿ / ((1 + r)ⁿ − 1) (or 1/n when r = 0)."/>
                                        <LineBreak/>
                                        <Run Text="• Annual Cost = Total Investment × CRF + Annual O&amp;M; Benefit-Cost Ratio = Annual Benefits ÷ Annual Cost."/>
                                    </TextBlock>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </TabItem>

            </TabControl>
        </ScrollViewer>
    </Grid>
</UserControl>
